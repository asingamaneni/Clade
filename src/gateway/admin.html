<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clade Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            surface: { DEFAULT: '#0f1117', 100: '#161b22', 200: '#1c2128', 300: '#282e36' },
            border: { DEFAULT: '#30363d' },
            accent: { DEFAULT: '#58a6ff' },
          },
          fontFamily: {
            mono: ['ui-monospace', '"SF Mono"', 'SFMono-Regular', 'Menlo', 'Consolas', 'monospace'],
          }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      background: #0f1117;
      color: #e6edf3;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      overflow: hidden;
      height: 100vh;
    }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #484f58; }

    /* ── Toggle switch (rounded pill) ─────────────────────── */
    .toggle-track {
      position: relative;
      width: 44px;
      height: 24px;
      background: #30363d;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s ease;
      flex-shrink: 0;
    }
    .toggle-track.active { background: #3fb950; }
    .toggle-track::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: #e6edf3;
      border-radius: 50%;
      transition: transform 0.2s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.4);
    }
    .toggle-track.active::after { transform: translateX(20px); }
    .toggle-track.disabled { opacity: 0.4; cursor: not-allowed; }

    /* ── Page transition ──────────────────────────────────── */
    .page-enter { animation: pageIn 0.15s ease-out; }
    @keyframes pageIn {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ── Form elements ────────────────────────────────────── */
    input[type="text"], input[type="password"], input[type="number"], input[type="time"],
    textarea, select {
      background: #0f1117;
      border: 1px solid #30363d;
      color: #e6edf3;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s;
      width: 100%;
    }
    input:focus, textarea:focus, select:focus { border-color: #58a6ff; }
    select option { background: #1c2128; color: #e6edf3; }
    textarea { resize: vertical; font-family: inherit; }
    textarea.mono-editor {
      font-family: ui-monospace, 'SF Mono', SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 13px;
      line-height: 1.5;
    }

    /* ── Badges ────────────────────────────────────────────── */
    .badge {
      display: inline-flex; align-items: center;
      padding: 2px 10px; border-radius: 9999px;
      font-size: 12px; font-weight: 500;
    }
    .badge-green  { background: rgba(63,185,80,0.15);  color: #3fb950; }
    .badge-yellow { background: rgba(210,153,34,0.15);  color: #d29922; }
    .badge-red    { background: rgba(248,81,73,0.15);   color: #f85149; }
    .badge-blue   { background: rgba(88,166,255,0.15);  color: #58a6ff; }
    .badge-purple { background: rgba(188,140,255,0.15); color: #bc8cff; }
    .badge-gray   { background: rgba(139,148,158,0.15); color: #8b949e; }

    /* ── Buttons ───────────────────────────────────────────── */
    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500;
      cursor: pointer; border: 1px solid transparent; transition: all 0.15s;
      white-space: nowrap;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary   { background: #238636; color: #fff; border-color: rgba(63,185,80,0.4); }
    .btn-primary:hover:not(:disabled)   { background: #2ea043; }
    .btn-danger    { background: rgba(248,81,73,0.1); color: #f85149; border-color: rgba(248,81,73,0.4); }
    .btn-danger:hover:not(:disabled)    { background: rgba(248,81,73,0.2); }
    .btn-secondary { background: #21262d; color: #c9d1d9; border-color: #30363d; }
    .btn-secondary:hover:not(:disabled) { background: #30363d; }
    .btn-accent    { background: rgba(88,166,255,0.1); color: #58a6ff; border-color: rgba(88,166,255,0.4); }
    .btn-accent:hover:not(:disabled)    { background: rgba(88,166,255,0.2); }

    /* ── Sidebar nav ──────────────────────────────────────── */
    .nav-item {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 16px; color: #8b949e; cursor: pointer;
      border-radius: 6px; margin: 1px 8px; transition: all 0.12s;
      font-size: 14px; user-select: none;
    }
    .nav-item:hover { background: #1c2128; color: #e6edf3; }
    .nav-item.active { background: rgba(88,166,255,0.1); color: #58a6ff; }

    /* ── Toasts ────────────────────────────────────────────── */
    .toast-container {
      position: fixed; top: 16px; right: 16px; z-index: 9999;
      display: flex; flex-direction: column; gap: 8px; pointer-events: none;
    }
    .toast {
      padding: 12px 20px; border-radius: 8px; font-size: 14px;
      animation: toastIn 0.2s ease-out, toastOut 0.3s ease-in 2.7s forwards;
      max-width: 400px; pointer-events: auto;
    }
    .toast-success { background: rgba(63,185,80,0.15); border: 1px solid rgba(63,185,80,0.3); color: #3fb950; }
    .toast-error   { background: rgba(248,81,73,0.15); border: 1px solid rgba(248,81,73,0.3); color: #f85149; }
    .toast-info    { background: rgba(88,166,255,0.15); border: 1px solid rgba(88,166,255,0.3); color: #58a6ff; }
    @keyframes toastIn  { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-10px); } }

    /* ── Preset buttons ───────────────────────────────────── */
    .preset-btn {
      padding: 6px 18px; border-radius: 9999px; font-size: 13px; font-weight: 600;
      cursor: pointer; border: 2px solid transparent; transition: all 0.15s; user-select: none;
    }
    .preset-btn.selected { box-shadow: 0 0 0 1px currentColor; }
    .preset-potato    { background: rgba(210,153,34,0.15);  color: #d29922; border-color: rgba(210,153,34,0.3); }
    .preset-potato:hover, .preset-potato.selected    { background: rgba(210,153,34,0.3); }
    .preset-coding    { background: rgba(88,166,255,0.15);  color: #58a6ff; border-color: rgba(88,166,255,0.3); }
    .preset-coding:hover, .preset-coding.selected    { background: rgba(88,166,255,0.3); }
    .preset-messaging { background: rgba(63,185,80,0.15);   color: #3fb950; border-color: rgba(63,185,80,0.3); }
    .preset-messaging:hover, .preset-messaging.selected { background: rgba(63,185,80,0.3); }
    .preset-full      { background: rgba(188,140,255,0.15); color: #bc8cff; border-color: rgba(188,140,255,0.3); }
    .preset-full:hover, .preset-full.selected        { background: rgba(188,140,255,0.3); }

    /* ── Tool card ─────────────────────────────────────────── */
    .tool-card {
      background: #1c2128; border: 1px solid #30363d; border-radius: 8px;
      padding: 12px 14px; display: flex; align-items: center;
      justify-content: space-between; gap: 12px; transition: border-color 0.15s;
    }
    .tool-card.enabled { border-color: rgba(63,185,80,0.4); }
    .tool-card:hover { border-color: #484f58; }
    .tool-card.enabled:hover { border-color: rgba(63,185,80,0.6); }

    /* ── Stat card ─────────────────────────────────────────── */
    .stat-card {
      background: #1c2128; border: 1px solid #30363d; border-radius: 10px;
      padding: 20px 24px; display: flex; flex-direction: column; gap: 8px;
      border-left: 3px solid transparent; transition: transform 0.1s;
    }
    .stat-card:hover { transform: translateY(-1px); }

    /* ── Chat bubbles ─────────────────────────────────────── */
    .chat-bubble {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .chat-bubble-user {
      background: rgba(88,166,255,0.15);
      color: #e6edf3;
      border-bottom-right-radius: 4px;
      margin-left: auto;
    }
    .chat-bubble-agent {
      background: #1c2128;
      border: 1px solid #30363d;
      color: #e6edf3;
      border-bottom-left-radius: 4px;
    }
    .chat-bubble code {
      background: rgba(110,118,129,0.2);
      padding: 1px 5px;
      border-radius: 4px;
      font-size: 13px;
      font-family: ui-monospace, 'SF Mono', monospace;
    }
    .chat-bubble pre {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 10px 12px;
      margin: 8px 0;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.4;
    }
    .chat-bubble pre code {
      background: none;
      padding: 0;
      font-size: 13px;
    }
    .chat-input-wrap {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      padding: 12px 16px;
      background: #161b22;
      border-top: 1px solid #30363d;
    }
    .chat-input-wrap textarea {
      flex: 1;
      resize: none;
      min-height: 40px;
      max-height: 120px;
      padding: 10px 14px;
      font-size: 14px;
      border-radius: 20px;
      background: #0f1117;
      border: 1px solid #30363d;
      color: #e6edf3;
      outline: none;
      transition: border-color 0.15s;
      font-family: inherit;
      line-height: 1.4;
    }
    .chat-input-wrap textarea:focus { border-color: #58a6ff; }
    .chat-send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #238636;
      color: #fff;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.15s;
      font-size: 16px;
    }
    .chat-send-btn:hover:not(:disabled) { background: #2ea043; }
    .chat-send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .typing-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 10px 16px;
      background: #1c2128;
      border: 1px solid #30363d;
      border-radius: 16px;
      border-bottom-left-radius: 4px;
    }
    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #8b949e;
      animation: typingBounce 1.4s ease-in-out infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-4px); opacity: 1; }
    }

    .chat-attach-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: transparent;
      color: #8b949e;
      border: 1px solid #30363d;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s;
      font-size: 18px;
    }
    .chat-attach-btn:hover { background: #1c2128; color: #e6edf3; border-color: #484f58; }

    .attachment-preview-bar {
      display: flex;
      gap: 8px;
      padding: 8px 16px 0;
      overflow-x: auto;
      background: #161b22;
    }
    .attachment-preview {
      position: relative;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: #1c2128;
      border: 1px solid #30363d;
      border-radius: 8px;
      font-size: 12px;
      color: #e6edf3;
      max-width: 200px;
      flex-shrink: 0;
    }
    .attachment-preview img {
      width: 32px;
      height: 32px;
      object-fit: cover;
      border-radius: 4px;
    }
    .attachment-preview .remove-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #f85149;
      color: #fff;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      line-height: 1;
    }

    .attachment-item {
      margin-top: 8px;
      border-radius: 6px;
      overflow: hidden;
    }
    .attachment-item img {
      max-width: 300px;
      max-height: 240px;
      border-radius: 6px;
      cursor: pointer;
      transition: opacity 0.15s;
    }
    .attachment-item img:hover { opacity: 0.85; }
    .attachment-item a {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(88,166,255,0.1);
      border: 1px solid rgba(88,166,255,0.3);
      border-radius: 6px;
      color: #58a6ff;
      text-decoration: none;
      font-size: 13px;
      transition: background 0.15s;
    }
    .attachment-item a:hover { background: rgba(88,166,255,0.2); }

    .chat-agent-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      cursor: pointer;
      border-radius: 6px;
      margin: 1px 6px;
      transition: background 0.12s;
    }
    .chat-agent-item:hover { background: #1c2128; }
    .chat-agent-item.active { background: rgba(88,166,255,0.1); }

    /* ── Chat tabs ─────────────────────────────────────────── */
    .chat-tabs {
      display: flex;
      align-items: center;
      gap: 0;
      overflow-x: auto;
      background: #161b22;
      border-bottom: 1px solid #30363d;
      min-height: 38px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .chat-tabs::-webkit-scrollbar { display: none; }
    .chat-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 7px 14px;
      font-size: 13px;
      color: #8b949e;
      cursor: pointer;
      white-space: nowrap;
      border-bottom: 2px solid transparent;
      transition: color 0.12s, border-color 0.12s, background 0.12s;
      position: relative;
      flex-shrink: 0;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
      font-family: inherit;
    }
    .chat-tab:hover { color: #e6edf3; background: rgba(88,166,255,0.04); }
    .chat-tab.active { color: #58a6ff; border-bottom-color: #58a6ff; }
    .tab-close {
      display: none;
      width: 16px;
      height: 16px;
      border-radius: 3px;
      background: transparent;
      color: #8b949e;
      border: none;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
      align-items: center;
      justify-content: center;
      padding: 0;
      flex-shrink: 0;
    }
    .chat-tab:hover .tab-close { display: inline-flex; }
    .tab-close:hover { background: rgba(248,81,73,0.2); color: #f85149; }
    .chat-tab-new {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 26px;
      border: 1px dashed #30363d;
      border-radius: 5px;
      background: transparent;
      color: #8b949e;
      cursor: pointer;
      font-size: 16px;
      flex-shrink: 0;
      margin: 0 6px;
      transition: all 0.12s;
    }
    .chat-tab-new:hover { border-color: #58a6ff; color: #58a6ff; background: rgba(88,166,255,0.06); }
    .chat-tab-actions {
      display: flex;
      align-items: center;
      margin-left: auto;
      padding: 0 8px;
      flex-shrink: 0;
    }
    .chat-tab-action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 5px;
      background: transparent;
      color: #8b949e;
      border: none;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.12s;
    }
    .chat-tab-action-btn:hover { background: rgba(248,81,73,0.15); color: #f85149; }

    /* ── Misc ──────────────────────────────────────────────── */
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    // ═══════════════════════════════════════════════════════════════════
    // Imports
    // ═══════════════════════════════════════════════════════════════════
    import { h, Fragment, render } from 'https://esm.sh/preact@10.19.3';
    import { useState, useEffect, useRef, useCallback, useMemo } from 'https://esm.sh/preact@10.19.3/hooks';
    import htm from 'https://esm.sh/htm@3.1.1';
    const html = htm.bind(h);

    // ═══════════════════════════════════════════════════════════════════
    // API Helper
    // ═══════════════════════════════════════════════════════════════════

    const api = async (path, opts = {}) => {
      const hasBody = opts.body != null;
      const headers = hasBody ? { 'Content-Type': 'application/json' } : {};
      const res = await fetch('/api' + path, {
        ...opts,
        headers: { ...headers, ...(opts.headers || {}) },
        body: hasBody ? JSON.stringify(opts.body) : undefined,
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'HTTP ' + res.status);
      return data;
    };

    const healthApi = () => fetch('/health').then(r => r.json()).catch(() => null);

    // ═══════════════════════════════════════════════════════════════════
    // Tool definitions & presets (matches src/agents/presets.ts)
    // ═══════════════════════════════════════════════════════════════════

    const TOOL_CATEGORIES = [
      {
        name: 'Fs',
        label: 'File System',
        icon: '\u{1F4C1}',
        tools: [
          { id: 'Read',         desc: 'Read files from the local filesystem' },
          { id: 'Edit',         desc: 'Exact string replacements in files' },
          { id: 'Write',        desc: 'Create or overwrite files on disk' },
          { id: 'Glob',         desc: 'Fast glob-based file pattern matching' },
          { id: 'Grep',         desc: 'Regex content search powered by ripgrep' },
          { id: 'NotebookEdit', desc: 'Edit Jupyter notebook cells' },
        ],
      },
      {
        name: 'Runtime',
        label: 'Runtime',
        icon: '\u{2699}\u{FE0F}',
        tools: [
          { id: 'Bash',      desc: 'Execute shell commands with timeout' },
          { id: 'Task',      desc: 'Spawn sub-agent tasks in parallel' },
          { id: 'TodoWrite', desc: 'Structured task list management' },
        ],
      },
      {
        name: 'Web',
        label: 'Web Access',
        icon: '\u{1F310}',
        tools: [
          { id: 'WebFetch',  desc: 'Fetch URLs and extract content via AI' },
          { id: 'WebSearch', desc: 'Search the web for current information' },
        ],
      },
      {
        name: 'Memory',
        label: 'Memory MCP',
        icon: '\u{1F9E0}',
        tools: [
          { id: 'mcp__memory__*', desc: 'Memory read, write, search, and list tools' },
        ],
      },
      {
        name: 'Sessions',
        label: 'Sessions MCP',
        icon: '\u{1F4AC}',
        tools: [
          { id: 'mcp__sessions__*', desc: 'Session spawn, list, send, and status tools' },
        ],
      },
      {
        name: 'Messaging',
        label: 'Messaging MCP',
        icon: '\u{1F4E8}',
        tools: [
          { id: 'mcp__messaging__*', desc: 'Cross-channel message sending tools' },
        ],
      },
      {
        name: 'Skills',
        label: 'Skills MCP',
        icon: '\u{1F9E9}',
        tools: [
          { id: 'mcp__skills__*', desc: 'Dynamic skill search and installation' },
        ],
      },
    ];

    const ALL_TOOL_IDS = TOOL_CATEGORIES.flatMap(c => c.tools.map(t => t.id));

    const PRESET_MAP = {
      potato: [],
      coding: [
        'Read', 'Edit', 'Write', 'Bash', 'Glob', 'Grep', 'NotebookEdit',
        'mcp__memory__*', 'mcp__sessions__*',
      ],
      messaging: [
        'mcp__memory__*', 'mcp__sessions__*', 'mcp__messaging__*',
      ],
      full: [...ALL_TOOL_IDS],
    };

    function detectPreset(tools) {
      for (const [name, list] of Object.entries(PRESET_MAP)) {
        if (list.length === tools.length && list.every(t => tools.includes(t))) return name;
      }
      return 'custom';
    }

    // ═══════════════════════════════════════════════════════════════════
    // Toast notifications
    // ═══════════════════════════════════════════════════════════════════

    let _toastId = 0;
    let _setToasts = null;

    function showToast(message, type) {
      if (!_setToasts) return;
      const id = ++_toastId;
      _setToasts(prev => [...prev, { id, message, type: type || 'info' }]);
      setTimeout(() => _setToasts(prev => prev.filter(t => t.id !== id)), 3200);
    }

    function ToastContainer() {
      const [toasts, setToasts] = useState([]);
      _setToasts = setToasts;
      return html`
        <div class="toast-container">
          ${toasts.map(t => html`
            <div key=${t.id} class="toast toast-${t.type}">${t.message}</div>
          `)}
        </div>
      `;
    }

    // ═══════════════════════════════════════════════════════════════════
    // Shared UI components
    // ═══════════════════════════════════════════════════════════════════

    function Toggle({ active, onToggle, disabled }) {
      return html`
        <div
          class="toggle-track ${active ? 'active' : ''} ${disabled ? 'disabled' : ''}"
          onClick=${() => !disabled && onToggle && onToggle(!active)}
        />
      `;
    }

    function StatusDot({ connected, size }) {
      const s = size || 8;
      return html`<span style="display:inline-block;width:${s}px;height:${s}px;border-radius:50%;background:${connected ? '#3fb950' : '#f85149'};flex-shrink:0" />`;
    }

    function Spinner({ size }) {
      const s = size || 16;
      return html`<span style="display:inline-block;width:${s}px;height:${s}px;border:2px solid #30363d;border-top-color:#58a6ff;border-radius:50%;animation:spin 0.6s linear infinite" />`;
    }

    function EmptyState({ icon, title, subtitle }) {
      return html`
        <div class="flex flex-col items-center justify-center py-16 text-center">
          <div class="text-4xl mb-3 opacity-40">${icon}</div>
          <div class="text-base font-medium" style="color:#8b949e">${title}</div>
          ${subtitle && html`<div class="text-sm mt-1" style="color:#484f58">${subtitle}</div>`}
        </div>
      `;
    }

    function TabBar({ tabs, active, onChange }) {
      return html`
        <div class="flex gap-0" style="border-bottom:1px solid #30363d">
          ${tabs.map(tab => html`
            <button
              key=${tab.id}
              onClick=${() => onChange(tab.id)}
              class="px-4 py-2.5 text-sm font-medium transition-colors relative"
              style="color:${active === tab.id ? '#e6edf3' : '#8b949e'};background:transparent;border:none;cursor:pointer"
            >
              ${tab.label}
              ${active === tab.id && html`
                <div class="absolute bottom-0 left-0 right-0" style="height:2px;background:#58a6ff;border-radius:1px" />
              `}
            </button>
          `)}
        </div>
      `;
    }

    function LoadingState({ text }) {
      return html`<div class="flex items-center gap-2 py-12 justify-center" style="color:#8b949e"><${Spinner} /> ${text || 'Loading...'}</div>`;
    }

    // ═══════════════════════════════════════════════════════════════════
    // Layout: Sidebar
    // ═══════════════════════════════════════════════════════════════════

    const NAV_ITEMS = [
      { id: 'dashboard', label: 'Dashboard',  icon: '\u{1F4CA}' },
      { id: 'chat',      label: 'Chat',       icon: '\u{1F4AC}' },
      { id: 'agents',    label: 'Agents',     icon: '\u{1F916}' },
      { id: 'sessions',  label: 'Sessions',   icon: '\u{1F5C2}' },
      { id: 'skills',    label: 'Skills',     icon: '\u{1F9E9}' },
      { id: 'channels',  label: 'Channels',   icon: '\u{1F4E1}' },
      { id: 'cron',      label: 'Cron',       icon: '\u{23F0}'  },
      { id: 'config',    label: 'Config',     icon: '\u{2699}\u{FE0F}' },
    ];

    function Sidebar({ page, setPage, agents, onNavigateToAgent }) {
      return html`
        <aside class="flex flex-col h-full" style="width:240px;min-width:240px;background:#161b22;border-right:1px solid #30363d">
          <!-- Logo -->
          <div class="px-4 py-4 flex items-center gap-2.5" style="border-bottom:1px solid #30363d">
            <span class="text-lg">\u{1F52E}</span>
            <span class="font-bold text-sm" style="color:#e6edf3;letter-spacing:-0.01em">Clade</span>
          </div>

          <!-- Navigation -->
          <nav class="flex-1 py-2 overflow-y-auto">
            <div class="px-4 pt-2 pb-1.5 text-xs font-semibold uppercase tracking-wider" style="color:#484f58">Navigation</div>
            ${NAV_ITEMS.map(item => html`
              <div
                key=${item.id}
                class="nav-item ${page === item.id ? 'active' : ''}"
                onClick=${() => setPage(item.id)}
              >
                <span class="text-base" style="width:20px;text-align:center">${item.icon}</span>
                <span>${item.label}</span>
              </div>
            `)}

            ${agents.length > 0 && html`
              <div class="px-4 pt-5 pb-1.5 text-xs font-semibold uppercase tracking-wider" style="color:#484f58">Agents</div>
              ${agents.map(a => html`
                <div
                  key=${a.id}
                  class="nav-item"
                  style="font-size:13px"
                  onClick=${() => onNavigateToAgent ? onNavigateToAgent(a.id) : setPage('agents')}
                >
                  <span class="text-sm" style="width:20px;text-align:center">${a.emoji || '\u{1F916}'}</span>
                  <span class="truncate flex-1">${a.name || a.id}</span>
                  ${a.skills && a.skills.length > 0 && html`
                    <span class="text-xs px-1.5 rounded" style="background:#282e36;color:#8b949e">${a.skills.length}</span>
                  `}
                </div>
              `)}
            `}
          </nav>

          <!-- Footer -->
          <div class="px-4 py-3 text-xs" style="border-top:1px solid #30363d;color:#484f58">
            Clade v0.1.0
          </div>
        </aside>
      `;
    }

    // ═══════════════════════════════════════════════════════════════════
    // Layout: TopBar
    // ═══════════════════════════════════════════════════════════════════

    function TopBar({ connected, health, agents }) {
      const port = health?.port || location.port || '7890';
      return html`
        <header class="flex items-center justify-between px-6" style="height:48px;min-height:48px;background:#161b22;border-bottom:1px solid #30363d">
          <h1 class="text-sm font-semibold" style="color:#e6edf3">Clade Admin</h1>
          <div class="flex items-center gap-5 text-xs" style="color:#8b949e">
            <div class="flex items-center gap-2">
              <${StatusDot} connected=${connected} />
              <span>${connected ? 'Connected' : 'Disconnected'}</span>
            </div>
            <span>Port ${port}</span>
            <span>${agents.length} agent${agents.length !== 1 ? 's' : ''}</span>
            ${health && html`<span>Uptime ${fmtUptime(health.uptime)}</span>`}
          </div>
        </header>
      `;
    }

    function fmtUptime(sec) {
      if (!sec && sec !== 0) return '--';
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = Math.floor(sec % 60);
      if (h > 0) return h + 'h ' + m + 'm';
      if (m > 0) return m + 'm ' + s + 's';
      return s + 's';
    }

    function fmtDate(d) {
      if (!d) return '--';
      try { return new Date(d).toLocaleString(); } catch { return String(d); }
    }

    // ═══════════════════════════════════════════════════════════════════
    // Template metadata for onboarding UI
    // ═══════════════════════════════════════════════════════════════════

    const TEMPLATE_META = {
      coding:   { icon: '\u{1F4BB}', color: '#58a6ff', border: 'rgba(88,166,255,0.4)',  bg: 'rgba(88,166,255,0.06)' },
      research: { icon: '\u{1F50D}', color: '#bc8cff', border: 'rgba(188,140,255,0.4)', bg: 'rgba(188,140,255,0.06)' },
      ops:      { icon: '\u{1F4E1}', color: '#3fb950', border: 'rgba(63,185,80,0.4)',   bg: 'rgba(63,185,80,0.06)' },
      pm:       { icon: '\u{1F4CB}', color: '#d29922', border: 'rgba(210,153,34,0.4)',  bg: 'rgba(210,153,34,0.06)' },
      custom:   { icon: '\u{2728}',  color: '#e6edf3', border: 'rgba(139,148,158,0.4)', bg: 'rgba(139,148,158,0.04)' },
    };

    // ═══════════════════════════════════════════════════════════════════
    //  ONBOARDING: Welcome Page (shown when 0 agents)
    // ═══════════════════════════════════════════════════════════════════

    function WelcomePage({ onCreated }) {
      const [templates, setTemplates] = useState([]);
      const [selected, setSelected] = useState(null);
      const [customMode, setCustomMode] = useState(false);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        api('/templates')
          .then(d => setTemplates(d.templates || []))
          .catch(() => {
            // Fallback templates if endpoint not available
            setTemplates([
              { id: 'coding',   name: 'Coding Partner',    description: 'Writes, reviews, and maintains code',                      toolPreset: 'coding',    model: 'sonnet', heartbeat: { interval: '30m' } },
              { id: 'research', name: 'Research Analyst',   description: 'Gathers, synthesizes, and reports on information',          toolPreset: 'full',      model: 'sonnet', heartbeat: { interval: '4h'  } },
              { id: 'ops',      name: 'Ops Monitor',        description: 'Monitors systems, checks health, handles incidents',        toolPreset: 'full',      model: 'sonnet', heartbeat: { interval: '15m' } },
              { id: 'pm',       name: 'Project Manager',    description: 'Tracks tasks, coordinates work, keeps projects moving',     toolPreset: 'messaging', model: 'sonnet', heartbeat: { interval: '1h'  } },
            ]);
          })
          .finally(() => setLoading(false));
      }, []);

      if (customMode) {
        return html`<${CustomAgentWizard} onCancel=${() => setCustomMode(false)} onCreated=${onCreated} />`;
      }

      if (selected) {
        return html`<${CreateAgentForm} template=${selected} onCancel=${() => setSelected(null)} onCreated=${onCreated} />`;
      }

      return html`
        <div class="page-enter flex flex-col items-center justify-center" style="min-height:calc(100vh - 48px);padding:2rem">
          <div style="max-width:720px;width:100%;text-align:center">
            <!-- Hero -->
            <div class="mb-2" style="font-size:48px">\u{1F52E}</div>
            <h1 class="text-3xl font-bold mb-2" style="color:#e6edf3">Welcome to Clade</h1>
            <p class="text-base mb-1" style="color:#8b949e;max-width:480px;margin:0 auto">
              Your personal team of AI agents, powered by Claude Code.
            </p>
            <p class="text-sm mb-8" style="color:#484f58;max-width:480px;margin:0 auto">
              Create your first agent to get started. Pick a template, or build one from scratch.
            </p>

            <!-- Template cards -->
            ${loading
              ? html`<${LoadingState} text="Loading templates..." />`
              : html`
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-left">
                  ${templates.map(t => {
                    const meta = TEMPLATE_META[t.id] || { icon: '\u{1F916}', color: '#8b949e', border: '#30363d', bg: 'transparent' };
                    return html`
                      <button
                        key=${t.id}
                        class="p-5 rounded-xl text-left transition-all"
                        style="background:${meta.bg};border:2px solid ${meta.border};cursor:pointer;outline:none"
                        onMouseEnter=${e => e.currentTarget.style.transform = 'translateY(-2px)'}
                        onMouseLeave=${e => e.currentTarget.style.transform = 'none'}
                        onClick=${() => setSelected(t)}
                      >
                        <div class="flex items-center gap-3 mb-3">
                          <div class="flex items-center justify-center rounded-xl" style="width:44px;height:44px;background:${meta.bg};border:1px solid ${meta.border};font-size:22px">
                            ${meta.icon}
                          </div>
                          <div>
                            <div class="text-sm font-bold" style="color:${meta.color}">${t.name}</div>
                            <div class="text-xs" style="color:#8b949e">${t.toolPreset} preset</div>
                          </div>
                        </div>
                        <p class="text-sm mb-3" style="color:#8b949e">${t.description}</p>
                        <div class="flex items-center gap-3 text-xs" style="color:#484f58">
                          <span>Model: ${t.model}</span>
                          <span>\u{00B7}</span>
                          <span>Heartbeat: ${t.heartbeat?.interval || '30m'}</span>
                        </div>
                      </button>
                    `;
                  })}
                </div>
              `
            }

            <!-- Custom agent card -->
            <div class="mt-4">
              <button
                class="w-full p-5 rounded-xl text-left transition-all"
                style="background:rgba(139,148,158,0.04);border:2px dashed rgba(139,148,158,0.3);cursor:pointer;outline:none"
                onMouseEnter=${e => { e.currentTarget.style.borderColor = 'rgba(230,237,243,0.5)'; e.currentTarget.style.transform = 'translateY(-2px)'; }}
                onMouseLeave=${e => { e.currentTarget.style.borderColor = 'rgba(139,148,158,0.3)'; e.currentTarget.style.transform = 'none'; }}
                onClick=${() => setCustomMode(true)}
              >
                <div class="flex items-center gap-3">
                  <div class="flex items-center justify-center rounded-xl" style="width:44px;height:44px;background:rgba(139,148,158,0.06);border:1px dashed rgba(139,148,158,0.3);font-size:22px">
                    \u{2728}
                  </div>
                  <div>
                    <div class="text-sm font-bold" style="color:#e6edf3">Custom Agent</div>
                    <div class="text-xs" style="color:#8b949e">Build from scratch — define your own personality, tools, and schedule</div>
                  </div>
                </div>
              </button>
            </div>

            <!-- CLI hint -->
            <div class="mt-8 p-4 rounded-lg text-sm" style="background:#161b22;border:1px solid #30363d;color:#8b949e">
              Or use the CLI: <code style="color:#58a6ff">clade agent add jarvis --template coding</code>
            </div>
          </div>
        </div>
      `;
    }

    // ═══════════════════════════════════════════════════════════════════
    //  ONBOARDING: Create Agent Form
    // ═══════════════════════════════════════════════════════════════════

    function CreateAgentForm({ template, onCancel, onCreated }) {
      const meta = TEMPLATE_META[template.id] || { icon: '\u{1F916}', color: '#8b949e', border: '#30363d', bg: 'transparent' };
      const [name, setName] = useState('');
      const [description, setDescription] = useState(template.name);
      const [model, setModel] = useState(template.model || 'sonnet');
      const [creating, setCreating] = useState(false);
      const [error, setError] = useState(null);
      const inputRef = useRef(null);

      useEffect(() => { inputRef.current && inputRef.current.focus(); }, []);

      const nameSlug = name.toLowerCase().replace(/[^a-z0-9_-]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');

      const create = async () => {
        if (!nameSlug) { setError('Name is required'); return; }
        setCreating(true);
        setError(null);
        try {
          await api('/agents', {
            method: 'POST',
            body: { name: nameSlug, template: template.id, description, model },
          });
          showToast('Agent "' + nameSlug + '" created!', 'success');
          onCreated && onCreated();
        } catch (e) {
          setError(e.message);
          showToast('Failed: ' + e.message, 'error');
        }
        setCreating(false);
      };

      return html`
        <div class="page-enter flex flex-col items-center justify-center" style="min-height:calc(100vh - 48px);padding:2rem">
          <div style="max-width:480px;width:100%">
            <!-- Back link -->
            <button
              class="flex items-center gap-1.5 mb-6 text-sm"
              style="color:#8b949e;background:none;border:none;cursor:pointer;padding:0"
              onClick=${onCancel}
            >
              \u{2190} Back to templates
            </button>

            <!-- Template badge -->
            <div class="flex items-center gap-3 mb-6">
              <div class="flex items-center justify-center rounded-xl" style="width:48px;height:48px;background:${meta.bg};border:1px solid ${meta.border};font-size:24px">
                ${meta.icon}
              </div>
              <div>
                <div class="text-lg font-bold" style="color:${meta.color}">${template.name}</div>
                <div class="text-sm" style="color:#8b949e">${template.description}</div>
              </div>
            </div>

            <!-- Form -->
            <div class="space-y-5">
              <div>
                <label class="block text-xs font-semibold mb-2 uppercase tracking-wider" style="color:#8b949e">Agent Name</label>
                <input
                  ref=${inputRef}
                  type="text"
                  value=${name}
                  onInput=${e => { setName(e.target.value); setError(null); }}
                  onKeyDown=${e => e.key === 'Enter' && create()}
                  placeholder="e.g. jarvis, ravi, manu"
                  style="font-size:16px;padding:12px 16px"
                />
                ${nameSlug && nameSlug !== name && html`
                  <div class="text-xs mt-1.5" style="color:#484f58">
                    Will be created as: <span style="color:#58a6ff;font-family:ui-monospace,monospace">${nameSlug}</span>
                  </div>
                `}
              </div>

              <div>
                <label class="block text-xs font-semibold mb-2 uppercase tracking-wider" style="color:#8b949e">Display Name</label>
                <input
                  type="text"
                  value=${description}
                  onInput=${e => setDescription(e.target.value)}
                  placeholder="Human-readable name"
                />
              </div>

              <div>
                <label class="block text-xs font-semibold mb-2 uppercase tracking-wider" style="color:#8b949e">Model</label>
                <div class="flex gap-2">
                  ${['sonnet', 'opus', 'haiku'].map(m => html`
                    <button
                      key=${m}
                      class="flex-1 py-2.5 rounded-lg text-sm font-medium transition-all"
                      style="background:${model === m ? 'rgba(88,166,255,0.15)' : '#161b22'};color:${model === m ? '#58a6ff' : '#8b949e'};border:1px solid ${model === m ? 'rgba(88,166,255,0.4)' : '#30363d'};cursor:pointer"
                      onClick=${() => setModel(m)}
                    >
                      ${m.charAt(0).toUpperCase() + m.slice(1)}
                    </button>
                  `)}
                </div>
              </div>

              ${error && html`
                <div class="p-3 rounded-lg text-sm" style="background:rgba(248,81,73,0.1);border:1px solid rgba(248,81,73,0.3);color:#f85149">
                  ${error}
                </div>
              `}

              <button
                class="btn btn-primary w-full justify-center"
                style="padding:14px;font-size:15px;border-radius:10px"
                onClick=${create}
                disabled=${creating || !nameSlug}
              >
                ${creating ? html`<${Spinner} size=${14} /> Creating...` : 'Create Agent'}
              </button>
            </div>

            <!-- What gets created -->
            <div class="mt-6 p-4 rounded-lg" style="background:#161b22;border:1px solid #30363d">
              <div class="text-xs font-semibold mb-2 uppercase tracking-wider" style="color:#484f58">What gets created</div>
              <div class="space-y-1 text-xs font-mono" style="color:#8b949e">
                <div>~/.clade/agents/${nameSlug || '<name>'}/SOUL.md</div>
                <div>~/.clade/agents/${nameSlug || '<name>'}/MEMORY.md</div>
                <div>~/.clade/agents/${nameSlug || '<name>'}/HEARTBEAT.md</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ═══════════════════════════════════════════════════════════════════
    //  ONBOARDING: Custom Agent Wizard (multi-step)
    // ═══════════════════════════════════════════════════════════════════

    const DEFAULT_CUSTOM_SOUL = `# SOUL.md — {AGENT_NAME}

_Describe who this agent is and how it approaches work._

## Core Principles

**Principle 1.** What matters most to this agent? What does it always prioritize?

**Principle 2.** How does it handle uncertainty or ambiguity?

**Principle 3.** What is its relationship with the human it works for?

## How You Work

- Describe the agent's working style
- What does it do on heartbeat?
- How does it communicate results?

## Growth

This agent evolves over time. What does it get better at?
`;

    const DEFAULT_CUSTOM_HEARTBEAT = `# Heartbeat Checklist

- [ ] Check for pending tasks or requests
- [ ] Review recent activity for anomalies
- [ ] Any scheduled items overdue?

If nothing needs attention, respond with: HEARTBEAT_OK
`;

    const TOOL_PRESET_INFO = {
      potato:    { label: 'None',      desc: 'Pure chat — no file or system access' },
      coding:    { label: 'Coding',    desc: 'Read, Edit, Write, Bash, Glob, Grep + memory' },
      messaging: { label: 'Messaging', desc: 'Memory, sessions, and messaging only' },
      full:      { label: 'Full',      desc: 'All Claude Code tools + all MCP servers' },
    };

    function CustomAgentWizard({ onCancel, onCreated }) {
      const [step, setStep] = useState(1);
      const [creating, setCreating] = useState(false);
      const [error, setError] = useState(null);
      const inputRef = useRef(null);

      // Step 1: Identity
      const [name, setName] = useState('');
      const [displayName, setDisplayName] = useState('');
      const [description, setDescription] = useState('');

      // Step 2: Personality & Tools
      const [toolPreset, setToolPreset] = useState('full');
      const [model, setModel] = useState('sonnet');
      const [soulContent, setSoulContent] = useState('');

      // Step 3: Heartbeat
      const [heartbeatEnabled, setHeartbeatEnabled] = useState(true);
      const [heartbeatInterval, setHeartbeatInterval] = useState('30m');
      const [heartbeatContent, setHeartbeatContent] = useState(DEFAULT_CUSTOM_HEARTBEAT);

      const nameSlug = name.toLowerCase().replace(/[^a-z0-9_-]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');

      useEffect(() => { inputRef.current && inputRef.current.focus(); }, [step]);

      // Initialize SOUL.md with agent name when moving to step 2
      const goToStep = (s) => {
        if (s === 2 && !soulContent) {
          setSoulContent(DEFAULT_CUSTOM_SOUL.replace('{AGENT_NAME}', displayName || nameSlug || 'My Agent'));
        }
        setStep(s);
      };

      const create = async () => {
        if (!nameSlug) { setError('Name is required'); return; }
        setCreating(true);
        setError(null);
        try {
          await api('/agents', {
            method: 'POST',
            body: {
              name: nameSlug,
              template: 'custom',
              description: displayName || nameSlug,
              agentDescription: description,
              model,
              toolPreset,
              soulContent: soulContent || undefined,
              heartbeatContent: heartbeatContent || undefined,
              heartbeatEnabled,
              heartbeatInterval,
            },
          });
          showToast('Agent "' + nameSlug + '" created!', 'success');
          onCreated && onCreated();
        } catch (e) {
          setError(e.message);
          showToast('Failed: ' + e.message, 'error');
        }
        setCreating(false);
      };

      const stepIndicator = html`
        <div class="flex items-center justify-center gap-2 mb-8">
          ${[1,2,3].map(s => html`
            <${Fragment} key=${s}>
              <button
                class="flex items-center justify-center rounded-full text-xs font-bold transition-all"
                style="width:32px;height:32px;background:${step >= s ? 'rgba(88,166,255,0.15)' : '#161b22'};color:${step >= s ? '#58a6ff' : '#484f58'};border:1px solid ${step >= s ? 'rgba(88,166,255,0.4)' : '#30363d'};cursor:${step > s ? 'pointer' : 'default'}"
                onClick=${() => step > s && goToStep(s)}
              >${s}</button>
              ${s < 3 ? html`<div style="width:40px;height:1px;background:${step > s ? 'rgba(88,166,255,0.4)' : '#30363d'}"></div>` : null}
            <//>
          `)}
        </div>
      `;

      return html`
        <div class="page-enter flex flex-col items-center justify-center" style="min-height:calc(100vh - 48px);padding:2rem">
          <div style="max-width:520px;width:100%">
            <!-- Back link -->
            <button
              class="flex items-center gap-1.5 mb-6 text-sm"
              style="color:#8b949e;background:none;border:none;cursor:pointer;padding:0"
              onClick=${step === 1 ? onCancel : () => goToStep(step - 1)}
            >
              \u{2190} ${step === 1 ? 'Back to templates' : 'Back'}
            </button>

            <!-- Header -->
            <div class="flex items-center gap-3 mb-2">
              <div class="flex items-center justify-center rounded-xl" style="width:48px;height:48px;background:rgba(139,148,158,0.06);border:1px dashed rgba(139,148,158,0.3);font-size:24px">
                \u{2728}
              </div>
              <div>
                <div class="text-lg font-bold" style="color:#e6edf3">Custom Agent</div>
                <div class="text-sm" style="color:#8b949e">
                  ${step === 1 ? 'Identity' : step === 2 ? 'Personality & Tools' : 'Schedule & Review'}
                </div>
              </div>
            </div>

            ${stepIndicator}

            <!-- ── Step 1: Identity ── -->
            ${step === 1 && html`
              <div class="space-y-5">
                <div>
                  <label class="block text-xs font-semibold mb-2 uppercase tracking-wider" style="color:#8b949e">Agent ID</label>
                  <input
                    ref=${inputRef}
                    type="text"
                    value=${name}
                    onInput=${e => { setName(e.target.value); setError(null); }}
                    onKeyDown=${e => e.key === 'Enter' && nameSlug && goToStep(2)}
                    placeholder="e.g. jarvis, scout, oracle"
                    style="font-size:16px;padding:12px 16px"
                  />
                  ${nameSlug && nameSlug !== name && html`
                    <div class="text-xs mt-1.5" style="color:#484f58">
                      Will be created as: <span style="color:#58a6ff;font-family:ui-monospace,monospace">${nameSlug}</span>
                    </div>
                  `}
                </div>

                <div>
                  <label class="block text-xs font-semibold mb-2 uppercase tracking-wider" style="color:#8b949e">Display Name</label>
                  <input
                    type="text"
                    value=${displayName}
                    onInput=${e => setDisplayName(e.target.value)}
                    placeholder="e.g. My Code Reviewer"
                    style="font-size:16px;padding:12px 16px"
                  />
                </div>

                <div>
                  <label class="block text-xs font-semibold mb-2 uppercase tracking-wider" style="color:#8b949e">Description</label>
                  <input
                    type="text"
                    value=${description}
                    onInput=${e => setDescription(e.target.value)}
                    placeholder="What does this agent do?"
                    style="font-size:16px;padding:12px 16px"
                  />
                </div>

                ${error && html`
                  <div class="p-3 rounded-lg text-sm" style="background:rgba(248,81,73,0.1);border:1px solid rgba(248,81,73,0.3);color:#f85149">${error}</div>
                `}

                <button
                  class="btn btn-primary w-full justify-center"
                  style="padding:14px;font-size:15px;border-radius:10px"
                  onClick=${() => nameSlug ? goToStep(2) : setError('Agent ID is required')}
                  disabled=${!nameSlug}
                >
                  Next \u{2192}
                </button>
              </div>
            `}

            <!-- ── Step 2: Personality & Tools ── -->
            ${step === 2 && html`
              <div class="space-y-5">
                <div>
                  <label class="block text-xs font-semibold mb-2 uppercase tracking-wider" style="color:#8b949e">Tool Access</label>
                  <div class="grid grid-cols-2 gap-2">
                    ${Object.entries(TOOL_PRESET_INFO).map(([key, info]) => html`
                      <button
                        key=${key}
                        class="p-3 rounded-lg text-left transition-all"
                        style="background:${toolPreset === key ? 'rgba(88,166,255,0.1)' : '#161b22'};border:1px solid ${toolPreset === key ? 'rgba(88,166,255,0.4)' : '#30363d'};cursor:pointer"
                        onClick=${() => setToolPreset(key)}
                      >
                        <div class="text-sm font-medium" style="color:${toolPreset === key ? '#58a6ff' : '#e6edf3'}">${info.label}</div>
                        <div class="text-xs mt-0.5" style="color:#484f58">${info.desc}</div>
                      </button>
                    `)}
                  </div>
                </div>

                <div>
                  <label class="block text-xs font-semibold mb-2 uppercase tracking-wider" style="color:#8b949e">Model</label>
                  <div class="flex gap-2">
                    ${['sonnet', 'opus', 'haiku'].map(m => html`
                      <button
                        key=${m}
                        class="flex-1 py-2.5 rounded-lg text-sm font-medium transition-all"
                        style="background:${model === m ? 'rgba(88,166,255,0.15)' : '#161b22'};color:${model === m ? '#58a6ff' : '#8b949e'};border:1px solid ${model === m ? 'rgba(88,166,255,0.4)' : '#30363d'};cursor:pointer"
                        onClick=${() => setModel(m)}
                      >
                        ${m.charAt(0).toUpperCase() + m.slice(1)}
                      </button>
                    `)}
                  </div>
                </div>

                <div>
                  <label class="block text-xs font-semibold mb-2 uppercase tracking-wider" style="color:#8b949e">
                    Personality (SOUL.md)
                  </label>
                  <div class="text-xs mb-2" style="color:#484f58">
                    Define how your agent thinks and works. Core Principles are locked after creation.
                  </div>
                  <textarea
                    ref=${inputRef}
                    value=${soulContent}
                    onInput=${e => setSoulContent(e.target.value)}
                    placeholder="Describe your agent's personality, principles, and working style..."
                    style="font-size:13px;padding:12px 16px;min-height:200px;resize:vertical;font-family:ui-monospace,monospace;line-height:1.5"
                  />
                </div>

                ${error && html`
                  <div class="p-3 rounded-lg text-sm" style="background:rgba(248,81,73,0.1);border:1px solid rgba(248,81,73,0.3);color:#f85149">${error}</div>
                `}

                <button
                  class="btn btn-primary w-full justify-center"
                  style="padding:14px;font-size:15px;border-radius:10px"
                  onClick=${() => goToStep(3)}
                >
                  Next \u{2192}
                </button>
              </div>
            `}

            <!-- ── Step 3: Heartbeat & Review ── -->
            ${step === 3 && html`
              <div class="space-y-5">
                <div>
                  <div class="flex items-center justify-between mb-2">
                    <label class="text-xs font-semibold uppercase tracking-wider" style="color:#8b949e">Heartbeat</label>
                    <button
                      class="text-xs px-3 py-1 rounded-full transition-all"
                      style="background:${heartbeatEnabled ? 'rgba(63,185,80,0.15)' : '#161b22'};color:${heartbeatEnabled ? '#3fb950' : '#484f58'};border:1px solid ${heartbeatEnabled ? 'rgba(63,185,80,0.4)' : '#30363d'};cursor:pointer"
                      onClick=${() => setHeartbeatEnabled(!heartbeatEnabled)}
                    >
                      ${heartbeatEnabled ? 'Enabled' : 'Disabled'}
                    </button>
                  </div>
                  ${heartbeatEnabled && html`
                    <div class="flex gap-2 mt-3">
                      ${['15m', '30m', '1h', '4h', 'daily'].map(iv => html`
                        <button
                          key=${iv}
                          class="flex-1 py-2 rounded-lg text-xs font-medium transition-all"
                          style="background:${heartbeatInterval === iv ? 'rgba(88,166,255,0.15)' : '#161b22'};color:${heartbeatInterval === iv ? '#58a6ff' : '#8b949e'};border:1px solid ${heartbeatInterval === iv ? 'rgba(88,166,255,0.4)' : '#30363d'};cursor:pointer"
                          onClick=${() => setHeartbeatInterval(iv)}
                        >
                          ${iv}
                        </button>
                      `)}
                    </div>
                  `}
                </div>

                ${heartbeatEnabled && html`
                  <div>
                    <label class="block text-xs font-semibold mb-2 uppercase tracking-wider" style="color:#8b949e">
                      Heartbeat Checklist
                    </label>
                    <textarea
                      value=${heartbeatContent}
                      onInput=${e => setHeartbeatContent(e.target.value)}
                      placeholder="What should the agent check on each heartbeat?"
                      style="font-size:13px;padding:12px 16px;min-height:120px;resize:vertical;font-family:ui-monospace,monospace;line-height:1.5"
                    />
                  </div>
                `}

                <!-- Summary -->
                <div class="p-4 rounded-lg" style="background:#161b22;border:1px solid #30363d">
                  <div class="text-xs font-semibold mb-3 uppercase tracking-wider" style="color:#484f58">Review</div>
                  <div class="space-y-2 text-sm" style="color:#8b949e">
                    <div class="flex justify-between">
                      <span>Agent ID</span>
                      <span style="color:#58a6ff;font-family:ui-monospace,monospace">${nameSlug}</span>
                    </div>
                    ${displayName && html`
                      <div class="flex justify-between">
                        <span>Display Name</span>
                        <span style="color:#e6edf3">${displayName}</span>
                      </div>
                    `}
                    ${description && html`
                      <div class="flex justify-between">
                        <span>Description</span>
                        <span style="color:#e6edf3">${description}</span>
                      </div>
                    `}
                    <div class="flex justify-between">
                      <span>Tools</span>
                      <span style="color:#e6edf3">${TOOL_PRESET_INFO[toolPreset]?.label || toolPreset}</span>
                    </div>
                    <div class="flex justify-between">
                      <span>Model</span>
                      <span style="color:#e6edf3">${model}</span>
                    </div>
                    <div class="flex justify-between">
                      <span>Heartbeat</span>
                      <span style="color:#e6edf3">${heartbeatEnabled ? heartbeatInterval : 'Off'}</span>
                    </div>
                    <div class="flex justify-between">
                      <span>SOUL.md</span>
                      <span style="color:#e6edf3">${soulContent ? (soulContent.length + ' chars') : 'Default'}</span>
                    </div>
                  </div>
                </div>

                <!-- What gets created -->
                <div class="p-4 rounded-lg" style="background:#161b22;border:1px solid #30363d">
                  <div class="text-xs font-semibold mb-2 uppercase tracking-wider" style="color:#484f58">What gets created</div>
                  <div class="space-y-1 text-xs font-mono" style="color:#8b949e">
                    <div>~/.clade/agents/${nameSlug}/SOUL.md</div>
                    <div>~/.clade/agents/${nameSlug}/MEMORY.md</div>
                    <div>~/.clade/agents/${nameSlug}/HEARTBEAT.md</div>
                  </div>
                </div>

                ${error && html`
                  <div class="p-3 rounded-lg text-sm" style="background:rgba(248,81,73,0.1);border:1px solid rgba(248,81,73,0.3);color:#f85149">${error}</div>
                `}

                <button
                  class="btn btn-primary w-full justify-center"
                  style="padding:14px;font-size:15px;border-radius:10px"
                  onClick=${create}
                  disabled=${creating || !nameSlug}
                >
                  ${creating ? html`<${Spinner} size=${14} /> Creating...` : 'Create Agent'}
                </button>
              </div>
            `}
          </div>
        </div>
      `;
    }

    // ═══════════════════════════════════════════════════════════════════
    //  PAGE: Chat
    // ═══════════════════════════════════════════════════════════════════

    function formatRelativeTime(isoStr) {
      if (!isoStr) return '';
      const diff = (Date.now() - new Date(isoStr).getTime()) / 1000;
      if (diff < 60) return 'just now';
      if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
      if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
      return Math.floor(diff / 86400) + 'd ago';
    }

    function renderMarkdown(text) {
      if (!text) return '';
      // Code blocks
      let result = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) =>
        '<pre><code>' + code.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</code></pre>'
      );
      // Inline code
      result = result.replace(/`([^`]+)`/g, '<code>$1</code>');
      // Bold
      result = result.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      // Italic
      result = result.replace(/\*(.+?)\*/g, '<em>$1</em>');
      // Line breaks (but not inside pre blocks)
      return result;
    }

    function formatFileSize(bytes) {
      if (!bytes || bytes === 0) return '0 B';
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function ChatPage({ agents }) {
      const [selectedAgent, setSelectedAgent] = useState(null);
      const [messages, setMessages] = useState([]);
      const [inputText, setInputText] = useState('');
      const [typing, setTyping] = useState(false);
      const [wsConnected, setWsConnected] = useState(false);
      // Per-agent conversation tabs
      const [agentConversations, setAgentConversations] = useState({}); // { agentId: [conv, ...] }
      const [activeConvId, setActiveConvId] = useState({}); // { agentId: convId }
      const [pendingAttachments, setPendingAttachments] = useState([]);
      const wsRef = useRef(null);
      const messagesEndRef = useRef(null);
      const inputRef = useRef(null);
      const fileInputRef = useRef(null);
      const clientIdRef = useRef(localStorage.getItem('clade-chat-clientId') || '');

      // Auto-scroll to bottom when messages change
      const scrollToBottom = useCallback(() => {
        if (messagesEndRef.current) {
          messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
        }
      }, []);

      useEffect(() => { scrollToBottom(); }, [messages, typing]);

      // ── Tab management helpers ────────────────────────────────
      const loadConversations = useCallback(async (agentId) => {
        try {
          const d = await fetch('/api/chat/history?agentId=' + encodeURIComponent(agentId)).then(r => r.json());
          const convs = d.conversations || [];
          setAgentConversations(prev => ({ ...prev, [agentId]: convs }));
          return convs;
        } catch {
          setAgentConversations(prev => ({ ...prev, [agentId]: [] }));
          return [];
        }
      }, []);

      const loadConversationMessages = useCallback(async (agentId, convId) => {
        try {
          const d = await fetch('/api/chat/history?agentId=' + encodeURIComponent(agentId) + '&conversationId=' + encodeURIComponent(convId)).then(r => r.json());
          setMessages(d.messages || []);
        } catch {
          setMessages([]);
        }
      }, []);

      const createNewConversation = useCallback(async (agentId) => {
        try {
          const resp = await fetch('/api/chat/conversations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ agentId }),
          });
          if (!resp.ok) {
            showToast('Failed to create conversation (server returned ' + resp.status + '). Try restarting the server.', 'error');
            return null;
          }
          const d = await resp.json();
          if (d.conversation) {
            setAgentConversations(prev => ({
              ...prev,
              [agentId]: [d.conversation, ...(prev[agentId] || [])],
            }));
            setActiveConvId(prev => ({ ...prev, [agentId]: d.conversation.id }));
            setMessages([]);
            return d.conversation;
          }
        } catch (e) {
          showToast('Failed to create conversation: ' + e.message, 'error');
        }
        return null;
      }, []);

      const deleteConversation = useCallback(async (agentId, convId) => {
        try {
          await fetch('/api/chat/conversations/' + encodeURIComponent(convId) + '?agentId=' + encodeURIComponent(agentId), { method: 'DELETE' });
          setAgentConversations(prev => {
            const list = (prev[agentId] || []).filter(c => c.id !== convId);
            return { ...prev, [agentId]: list };
          });
          // If deleting the active tab, switch to the next available
          setActiveConvId(prev => {
            if (prev[agentId] !== convId) return prev;
            const list = (agentConversations[agentId] || []).filter(c => c.id !== convId);
            const nextId = list.length > 0 ? list[0].id : null;
            if (nextId) {
              loadConversationMessages(agentId, nextId);
            } else {
              setMessages([]);
            }
            return { ...prev, [agentId]: nextId };
          });
        } catch (e) {
          showToast('Failed to delete conversation: ' + e.message, 'error');
        }
      }, [agentConversations, loadConversationMessages]);

      const clearAllConversations = useCallback(async (agentId) => {
        try {
          await fetch('/api/chat/conversations?agentId=' + encodeURIComponent(agentId), { method: 'DELETE' });
          setAgentConversations(prev => ({ ...prev, [agentId]: [] }));
          setActiveConvId(prev => ({ ...prev, [agentId]: null }));
          setMessages([]);
        } catch (e) {
          showToast('Failed to clear conversations: ' + e.message, 'error');
        }
      }, []);

      const switchTab = useCallback((agentId, convId) => {
        setActiveConvId(prev => ({ ...prev, [agentId]: convId }));
        loadConversationMessages(agentId, convId);
      }, [loadConversationMessages]);

      // WebSocket connection
      useEffect(() => {
        let ws;
        let reconTimer;

        const connect = () => {
          const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
          ws = new WebSocket(proto + '//' + location.host + '/ws');
          wsRef.current = ws;

          ws.onopen = () => setWsConnected(true);

          ws.onmessage = (e) => {
            try {
              const data = JSON.parse(e.data);
              switch (data.type) {
                case 'connected':
                  clientIdRef.current = data.clientId;
                  localStorage.setItem('clade-chat-clientId', data.clientId);
                  break;
                case 'message_ack': {
                  const convId = data.conversationId;
                  const agentId = data.message.agentId;
                  // Single state update to avoid race between setting activeConvId and reading it
                  setActiveConvId(prev => {
                    const isNew = convId && !prev[agentId];
                    const isActive = !convId || prev[agentId] === convId || isNew;
                    if (isActive) {
                      setMessages(msgs => [...msgs, data.message]);
                    }
                    if (isNew) return { ...prev, [agentId]: convId };
                    return prev;
                  });
                  if (agentId) loadConversations(agentId);
                  break;
                }
                case 'typing': {
                  setActiveConvId(prev => {
                    if (!data.conversationId || prev[data.agentId] === data.conversationId) {
                      setTyping(true);
                    }
                    return prev;
                  });
                  break;
                }
                case 'message': {
                  const convId = data.conversationId;
                  setTyping(false);
                  setActiveConvId(prev => {
                    if (!convId || prev[data.message.agentId] === convId) {
                      setMessages(msgs => [...msgs, data.message]);
                    }
                    return prev;
                  });
                  if (data.message.agentId) loadConversations(data.message.agentId);
                  break;
                }
                case 'error':
                  setTyping(false);
                  showToast(data.text, 'error');
                  break;
              }
            } catch (_) {}
          };

          ws.onclose = () => {
            setWsConnected(false);
            wsRef.current = null;
            reconTimer = setTimeout(connect, 3000);
          };

          ws.onerror = () => ws.close();
        };

        connect();
        return () => { clearTimeout(reconTimer); if (ws) ws.close(); };
      }, [loadConversations]);

      // Load conversations when agent is selected
      useEffect(() => {
        if (!selectedAgent) { setMessages([]); return; }
        loadConversations(selectedAgent).then(convs => {
          if (convs.length > 0) {
            const firstId = convs[0].id;
            setActiveConvId(prev => ({ ...prev, [selectedAgent]: firstId }));
            loadConversationMessages(selectedAgent, firstId);
          } else {
            setActiveConvId(prev => ({ ...prev, [selectedAgent]: null }));
            setMessages([]);
          }
        });
      }, [selectedAgent, loadConversations, loadConversationMessages]);

      // Focus input when agent changes
      useEffect(() => {
        if (selectedAgent && inputRef.current) inputRef.current.focus();
      }, [selectedAgent]);

      const sendMessage = useCallback(() => {
        const text = inputText.trim();
        if ((!text && pendingAttachments.length === 0) || !selectedAgent || !wsRef.current || wsRef.current.readyState !== 1) return;

        // Use active conversation if available; otherwise let server auto-create
        const convId = activeConvId[selectedAgent] || '';

        const payload = {
          type: 'message',
          agentId: selectedAgent,
          text: text || (pendingAttachments.length > 0 ? '(attached files)' : ''),
        };
        if (convId) payload.conversationId = convId;
        if (pendingAttachments.length > 0) {
          payload.attachments = pendingAttachments.map(a => ({
            name: a.name,
            type: a.type,
            size: a.size,
            data: a.data,
          }));
        }
        wsRef.current.send(JSON.stringify(payload));
        setInputText('');
        setPendingAttachments([]);
        // Reset textarea height
        if (inputRef.current) inputRef.current.style.height = 'auto';
      }, [inputText, selectedAgent, pendingAttachments, activeConvId]);

      const handleKeyDown = useCallback((e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      }, [sendMessage]);

      const handleInput = useCallback((e) => {
        setInputText(e.target.value);
        // Auto-resize textarea
        e.target.style.height = 'auto';
        e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px';
      }, []);

      const handleFileSelect = useCallback((e) => {
        const files = Array.from(e.target.files || []);
        if (files.length === 0) return;

        files.forEach(file => {
          if (file.size > 10 * 1024 * 1024) {
            showToast('File "' + file.name + '" exceeds 10 MB limit', 'error');
            return;
          }
          const reader = new FileReader();
          reader.onload = () => {
            const base64 = reader.result.split(',')[1];
            setPendingAttachments(prev => [...prev, {
              id: Date.now() + '_' + Math.random().toString(36).slice(2, 8),
              name: file.name,
              type: file.type || 'application/octet-stream',
              size: file.size,
              data: base64,
              preview: file.type.startsWith('image/') ? reader.result : null,
            }]);
          };
          reader.readAsDataURL(file);
        });

        // Reset file input so the same file can be re-selected
        e.target.value = '';
      }, []);

      const removeAttachment = useCallback((id) => {
        setPendingAttachments(prev => prev.filter(a => a.id !== id));
      }, []);

      const selectedAgentData = agents.find(a => a.id === selectedAgent);
      const currentConvs = selectedAgent ? (agentConversations[selectedAgent] || []) : [];
      const currentConvId = selectedAgent ? activeConvId[selectedAgent] : null;

      // Compute sidebar previews from agentConversations
      const sidebarPreviews = useMemo(() => {
        const map = {};
        for (const [agentId, convs] of Object.entries(agentConversations)) {
          if (!Array.isArray(convs) || convs.length === 0) continue;
          // Use the most recent conversation for sidebar preview
          const latest = convs[0];
          map[agentId] = {
            messageCount: convs.reduce((sum, c) => sum + (c.messageCount || 0), 0),
            lastMessage: latest?.lastMessage || null,
          };
        }
        return map;
      }, [agentConversations]);

      return html`
        <div class="page-enter flex h-full">
          <!-- Agent conversation list (left panel) -->
          <div class="flex flex-col" style="width:260px;min-width:260px;border-right:1px solid #30363d;background:#161b22">
            <div class="px-4 py-3 flex items-center justify-between" style="border-bottom:1px solid #30363d">
              <span class="text-sm font-semibold" style="color:#e6edf3">Conversations</span>
              <div class="flex items-center gap-1.5">
                <${StatusDot} connected=${wsConnected} size=${6} />
                <span class="text-xs" style="color:#8b949e">${wsConnected ? 'Live' : 'Offline'}</span>
              </div>
            </div>
            <div class="flex-1 overflow-y-auto py-2">
              ${agents.length === 0
                ? html`<div class="px-4 py-8 text-center text-sm" style="color:#8b949e">No agents configured</div>`
                : agents.map(a => {
                    const preview = sidebarPreviews[a.id];
                    return html`
                      <div
                        key=${a.id}
                        class="chat-agent-item ${selectedAgent === a.id ? 'active' : ''}"
                        onClick=${() => setSelectedAgent(a.id)}
                      >
                        <div class="flex items-center justify-center flex-shrink-0 rounded-full" style="width:36px;height:36px;background:#282e36;font-size:16px">
                          ${a.emoji || '\u{1F916}'}
                        </div>
                        <div class="flex-1 min-w-0">
                          <div class="flex items-center justify-between">
                            <span class="text-sm font-medium truncate" style="color:${selectedAgent === a.id ? '#58a6ff' : '#e6edf3'}">${a.name || a.id}</span>
                            ${preview?.lastMessage?.timestamp && html`
                              <span class="text-xs flex-shrink-0" style="color:#484f58">${formatRelativeTime(preview.lastMessage.timestamp)}</span>
                            `}
                          </div>
                          <div class="text-xs truncate" style="color:#8b949e;margin-top:1px">
                            ${preview?.lastMessage
                              ? (preview.lastMessage.role === 'user' ? 'You: ' : '') + preview.lastMessage.text
                              : a.description || 'No messages yet'
                            }
                          </div>
                        </div>
                      </div>
                    `;
                  })
              }
            </div>
          </div>

          <!-- Chat area (right panel) -->
          <div class="flex flex-col flex-1 min-w-0">
            ${selectedAgentData ? html`
              <!-- Chat header -->
              <div class="flex items-center gap-3 px-5" style="height:56px;min-height:56px;border-bottom:1px solid #30363d;background:#161b22">
                <div class="flex items-center justify-center rounded-full flex-shrink-0" style="width:32px;height:32px;background:#282e36;font-size:16px">
                  ${selectedAgentData.emoji || '\u{1F916}'}
                </div>
                <div class="min-w-0">
                  <div class="text-sm font-semibold truncate" style="color:#e6edf3">${selectedAgentData.name || selectedAgentData.id}</div>
                  <div class="text-xs" style="color:#8b949e">${selectedAgentData.model || 'sonnet'} \u{00B7} ${selectedAgentData.toolPreset || 'full'}</div>
                </div>
              </div>

              <!-- Tab bar -->
              <div class="chat-tabs">
                ${currentConvs.map(conv => html`
                  <button
                    key=${conv.id}
                    class="chat-tab ${currentConvId === conv.id ? 'active' : ''}"
                    onClick=${() => switchTab(selectedAgent, conv.id)}
                  >
                    <span class="truncate" style="max-width:140px">${conv.label || 'New chat'}</span>
                    <button
                      class="tab-close"
                      onClick=${(e) => { e.stopPropagation(); deleteConversation(selectedAgent, conv.id); }}
                      title="Close tab"
                    >\u{00D7}</button>
                  </button>
                `)}
                <button
                  class="chat-tab-new"
                  onClick=${() => createNewConversation(selectedAgent)}
                  title="New conversation"
                >+</button>
                ${currentConvs.length > 0 && html`
                  <div class="chat-tab-actions">
                    <button
                      class="chat-tab-action-btn"
                      onClick=${() => clearAllConversations(selectedAgent)}
                      title="Clear all conversations"
                    >\u{1F5D1}</button>
                  </div>
                `}
              </div>

              <!-- Messages area -->
              <div class="flex-1 overflow-y-auto px-5 py-4" style="background:#0f1117">
                ${messages.length === 0 && !typing ? html`
                  <div class="flex flex-col items-center justify-center h-full text-center">
                    <div class="text-4xl mb-3 opacity-40">${selectedAgentData.emoji || '\u{1F916}'}</div>
                    <div class="text-sm font-medium" style="color:#8b949e">
                      ${currentConvId ? 'Send a message to start this conversation' : 'Click + to start a new conversation'}
                    </div>
                    <div class="text-xs mt-1" style="color:#484f58">Messages are saved and persist across sessions</div>
                  </div>
                ` : html`
                  <div class="flex flex-col gap-3">
                    ${messages.map(msg => html`
                      <div key=${msg.id} class="flex flex-col ${msg.role === 'user' ? 'items-end' : 'items-start'}">
                        <div
                          class="chat-bubble ${msg.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-agent'}"
                        >
                          <div dangerouslySetInnerHTML=${{ __html: msg.role === 'assistant' ? renderMarkdown(msg.text) : msg.text.replace(/</g, '&lt;').replace(/>/g, '&gt;') }} />
                          ${msg.attachments && msg.attachments.length > 0 && html`
                            <div class="flex flex-col gap-2 mt-2">
                              ${msg.attachments.map(att => html`
                                <div class="attachment-item" key=${att.url}>
                                  ${att.type.startsWith('image/')
                                    ? html`<a href=${att.url} target="_blank" rel="noopener"><img src=${att.url} alt=${att.name} loading="lazy" /></a>`
                                    : html`<a href=${att.url} download=${att.name} target="_blank" rel="noopener">\u{1F4CE} ${att.name} (${formatFileSize(att.size)})</a>`
                                  }
                                </div>
                              `)}
                            </div>
                          `}
                        </div>
                        <span class="text-xs mt-1 px-1" style="color:#484f58">${formatRelativeTime(msg.timestamp)}</span>
                      </div>
                    `)}
                    ${typing && html`
                      <div class="flex flex-col items-start">
                        <div class="typing-indicator">
                          <div class="typing-dot"></div>
                          <div class="typing-dot"></div>
                          <div class="typing-dot"></div>
                        </div>
                      </div>
                    `}
                    <div ref=${messagesEndRef} />
                  </div>
                `}
              </div>

              <!-- Attachment preview bar -->
              ${pendingAttachments.length > 0 && html`
                <div class="attachment-preview-bar">
                  ${pendingAttachments.map(att => html`
                    <div class="attachment-preview" key=${att.id}>
                      ${att.preview
                        ? html`<img src=${att.preview} alt=${att.name} />`
                        : html`<span style="font-size:16px">\u{1F4CE}</span>`
                      }
                      <span class="truncate" style="max-width:120px">${att.name}</span>
                      <button class="remove-btn" onClick=${() => removeAttachment(att.id)} title="Remove">\u{00D7}</button>
                    </div>
                  `)}
                </div>
              `}

              <!-- Input bar -->
              <div class="chat-input-wrap">
                <input
                  ref=${fileInputRef}
                  type="file"
                  multiple
                  style="display:none"
                  onChange=${handleFileSelect}
                  accept="image/*,.txt,.md,.json,.csv,.xml,.yaml,.yml,.log,.pdf,.zip,.gz"
                />
                <button
                  class="chat-attach-btn"
                  onClick=${() => fileInputRef.current && fileInputRef.current.click()}
                  disabled=${!wsConnected}
                  title="Attach files"
                >
                  \u{1F4CE}
                </button>
                <textarea
                  ref=${inputRef}
                  value=${inputText}
                  onInput=${handleInput}
                  onKeyDown=${handleKeyDown}
                  placeholder="Type a message... (Enter to send, Shift+Enter for newline)"
                  rows="1"
                  disabled=${!wsConnected}
                />
                <button
                  class="chat-send-btn"
                  onClick=${sendMessage}
                  disabled=${(!inputText.trim() && pendingAttachments.length === 0) || !wsConnected || typing}
                  title="Send message"
                >
                  \u{2191}
                </button>
              </div>
            ` : html`
              <!-- No agent selected -->
              <div class="flex-1 flex items-center justify-center" style="background:#0f1117">
                <${EmptyState}
                  icon="\u{1F4AC}"
                  title="Select an agent to chat"
                  subtitle="Choose from the conversation list on the left"
                />
              </div>
            `}
          </div>
        </div>
      `;
    }

    // ═══════════════════════════════════════════════════════════════════
    //  PAGE 1: Dashboard
    // ═══════════════════════════════════════════════════════════════════

    function DashboardPage({ health, agents, sessions, cronJobs, onNavigateToAgent }) {
      const activeSessions = sessions.filter(s => s.status === 'active').length;

      const stats = [
        { label: 'Uptime',          value: fmtUptime(health?.uptime), color: '#58a6ff', icon: '\u{23F1}\u{FE0F}' },
        { label: 'Active Agents',   value: agents.length,             color: '#3fb950', icon: '\u{1F916}' },
        { label: 'Active Sessions', value: activeSessions,            color: '#bc8cff', icon: '\u{1F4AC}' },
        { label: 'Cron Jobs',       value: cronJobs.length,           color: '#d29922', icon: '\u{23F0}'  },
      ];

      return html`
        <div class="page-enter p-6">
          <h2 class="text-xl font-semibold mb-6" style="color:#e6edf3">Dashboard</h2>

          <!-- Stats grid -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            ${stats.map(s => html`
              <div key=${s.label} class="stat-card" style="border-left-color:${s.color}">
                <div class="flex items-center gap-2">
                  <span class="text-lg">${s.icon}</span>
                  <span class="text-xs font-medium uppercase tracking-wider" style="color:#8b949e">${s.label}</span>
                </div>
                <div class="text-2xl font-bold" style="color:#e6edf3">${s.value != null ? s.value : '--'}</div>
              </div>
            `)}
          </div>

          <!-- Two-column overview -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Recent sessions -->
            <div class="rounded-lg p-5" style="background:#1c2128;border:1px solid #30363d">
              <h3 class="text-sm font-semibold mb-3" style="color:#e6edf3">Recent Sessions</h3>
              ${sessions.length === 0
                ? html`<div class="text-sm" style="color:#8b949e">No sessions yet.</div>`
                : html`
                  <div class="space-y-2">
                    ${sessions.slice(0, 6).map(s => html`
                      <div key=${s.id} class="flex items-center justify-between py-2 px-3 rounded" style="background:#161b22">
                        <div class="flex items-center gap-3 min-w-0">
                          <span class="font-mono text-xs flex-shrink-0" style="color:#58a6ff">${(s.agentId || s.agent_id || '--')}</span>
                          <span class="text-sm truncate" style="color:#e6edf3">${s.label || s.id.slice(0,12)}</span>
                        </div>
                        <span class="badge flex-shrink-0 ${s.status === 'active' ? 'badge-green' : s.status === 'idle' ? 'badge-yellow' : 'badge-gray'}">${s.status}</span>
                      </div>
                    `)}
                  </div>
                `
              }
            </div>

            <!-- Agents overview -->
            <div class="rounded-lg p-5" style="background:#1c2128;border:1px solid #30363d">
              <h3 class="text-sm font-semibold mb-3" style="color:#e6edf3">Agents</h3>
              ${agents.length === 0
                ? html`<div class="text-sm" style="color:#8b949e">No agents configured.</div>`
                : html`
                  <div class="space-y-2">
                    ${agents.map(a => html`
                      <div key=${a.id}
                        class="flex items-center justify-between py-2 px-3 rounded cursor-pointer transition-colors"
                        style="background:#161b22"
                        onClick=${() => onNavigateToAgent && onNavigateToAgent(a.id)}
                        onMouseEnter=${(e) => e.currentTarget.style.background = '#1c2433'}
                        onMouseLeave=${(e) => e.currentTarget.style.background = '#161b22'}
                      >
                        <div class="flex items-center gap-3 min-w-0">
                          <span>${a.emoji || '\u{1F916}'}</span>
                          <div class="min-w-0">
                            <div class="text-sm font-medium truncate" style="color:#e6edf3">${a.name}</div>
                            <div class="text-xs truncate" style="color:#8b949e">${a.description || a.id}</div>
                          </div>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                          <span class="badge badge-blue">${a.toolPreset}</span>
                          <span style="color:#484f58;font-size:14px">\u{203A}</span>
                        </div>
                      </div>
                    `)}
                  </div>
                `
              }
            </div>
          </div>
        </div>
      `;
    }

    // ═══════════════════════════════════════════════════════════════════
    //  PAGE 2: Agents
    // ═══════════════════════════════════════════════════════════════════

    function AgentsPage({ agents, onRefresh, onNavigate, initialSelectedId, onAgentDeleted }) {
      const [selectedId, setSelectedId] = useState(initialSelectedId || null);
      const [showCreate, setShowCreate] = useState(false);

      // Use initialSelectedId when it changes (e.g. navigating from dashboard)
      useEffect(() => {
        if (initialSelectedId && agents.find(a => a.id === initialSelectedId)) {
          setSelectedId(initialSelectedId);
        }
      }, [initialSelectedId]);

      // Auto-select first agent if none selected
      useEffect(() => {
        if (agents.length > 0 && (!selectedId || !agents.find(a => a.id === selectedId))) {
          setSelectedId(agents[0].id);
        }
      }, [agents]);

      const selectedAgent = agents.find(a => a.id === selectedId);

      if (showCreate) {
        return html`<${WelcomePage} onCreated=${() => { setShowCreate(false); onRefresh && onRefresh(); }} />`;
      }

      return html`
        <div class="page-enter flex h-full">
          <!-- Agent sub-sidebar -->
          <div class="flex flex-col py-3" style="width:200px;min-width:200px;border-right:1px solid #30363d;background:#161b22">
            <div class="flex items-center justify-between px-3 pb-2">
              <span class="text-xs font-semibold uppercase tracking-wider" style="color:#484f58">Agents</span>
              <button
                class="text-xs font-medium px-2 py-1 rounded"
                style="background:rgba(35,134,54,0.15);color:#3fb950;border:1px solid rgba(63,185,80,0.3);cursor:pointer"
                onClick=${() => setShowCreate(true)}
              >+ New</button>
            </div>
            <div class="flex-1 overflow-y-auto">
              ${agents.length === 0
                ? html`<div class="px-3 py-4 text-sm" style="color:#8b949e">No agents</div>`
                : agents.map(a => html`
                  <div
                    key=${a.id}
                    class="flex items-center gap-2 px-3 py-2.5 mx-2 rounded cursor-pointer transition-colors text-sm"
                    style="background:${selectedId === a.id ? 'rgba(88,166,255,0.1)' : 'transparent'};color:${selectedId === a.id ? '#58a6ff' : '#8b949e'}"
                    onClick=${() => setSelectedId(a.id)}
                  >
                    <span>\u{1F916}</span>
                    <span class="truncate flex-1">${a.name || a.id}</span>
                    ${a.skills && a.skills.length > 0 && html`
                      <span class="text-xs opacity-60">${a.skills.length}sk</span>
                    `}
                  </div>
                `)
              }
            </div>
          </div>

          <!-- Agent detail panel -->
          <div class="flex-1 overflow-y-auto">
            ${selectedAgent
              ? html`<${AgentDetail} agent=${selectedAgent} onRefresh=${onRefresh} onDeleted=${onAgentDeleted} />`
              : html`<${EmptyState} icon="\u{1F916}" title="Select an agent" subtitle="Choose from the list to view details" />`
            }
          </div>
        </div>
      `;
    }

    // ── Agent detail with tabs ───────────────────────────────────────

    function AgentDetail({ agent, onRefresh, onDeleted }) {
      const [tab, setTab] = useState('soul');
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
      const [deleting, setDeleting] = useState(false);
      const tabs = [
        { id: 'soul',      label: 'Soul' },
        { id: 'identity',  label: 'Identity' },
        { id: 'tools',     label: 'Tools' },
        { id: 'memory',    label: 'Memory' },
        { id: 'heartbeat', label: 'Heartbeat' },
      ];

      const handleDelete = async () => {
        setDeleting(true);
        try {
          await api('/agents/' + agent.id, { method: 'DELETE' });
          showToast('Agent "' + agent.id + '" deleted', 'success');
          setShowDeleteConfirm(false);
          onDeleted && onDeleted();
        } catch (e) {
          showToast('Delete failed: ' + e.message, 'error');
        }
        setDeleting(false);
      };

      return html`
        <div class="p-5">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="flex items-center justify-center rounded-full" style="width:40px;height:40px;background:#282e36;font-size:20px">${agent.emoji || '\u{1F916}'}</div>
              <div>
                <h2 class="text-lg font-semibold" style="color:#e6edf3">${agent.name}</h2>
                <div class="text-xs" style="color:#8b949e">${agent.id} \u{00B7} ${agent.model || 'sonnet'} \u{00B7} ${agent.toolPreset}</div>
              </div>
            </div>
            <button
              class="text-xs px-3 py-1.5 rounded transition-colors"
              style="color:#f85149;border:1px solid rgba(248,81,73,0.3);background:transparent;cursor:pointer"
              onMouseEnter=${(e) => { e.currentTarget.style.background = 'rgba(248,81,73,0.15)'; }}
              onMouseLeave=${(e) => { e.currentTarget.style.background = 'transparent'; }}
              onClick=${() => setShowDeleteConfirm(true)}
            >Delete Agent</button>
          </div>

          ${showDeleteConfirm && html`
            <div class="mb-4 p-4 rounded-lg" style="background:rgba(248,81,73,0.1);border:1px solid rgba(248,81,73,0.3)">
              <div class="text-sm font-medium mb-2" style="color:#f85149">Delete "${agent.name}"?</div>
              <div class="text-xs mb-3" style="color:#8b949e">This will remove the agent from config. Agent files in ~/.clade/agents/${agent.id}/ will remain on disk.</div>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs px-3 py-1.5 rounded font-medium"
                  style="background:#f85149;color:#fff;border:none;cursor:pointer"
                  onClick=${handleDelete}
                  disabled=${deleting}
                >${deleting ? 'Deleting...' : 'Yes, delete'}</button>
                <button
                  class="text-xs px-3 py-1.5 rounded"
                  style="background:#282e36;color:#8b949e;border:1px solid #30363d;cursor:pointer"
                  onClick=${() => setShowDeleteConfirm(false)}
                >Cancel</button>
              </div>
            </div>
          `}

          <${TabBar} tabs=${tabs} active=${tab} onChange=${setTab} />

          <div class="pt-4">
            ${tab === 'soul'      && html`<${SoulTab} agentId=${agent.id} />`}
            ${tab === 'identity'  && html`<${IdentityTab} agentId=${agent.id} />`}
            ${tab === 'tools'     && html`<${ToolsTab} agent=${agent} onRefresh=${onRefresh} />`}
            ${tab === 'memory'    && html`<${MemoryTab} agentId=${agent.id} />`}
            ${tab === 'heartbeat' && html`<${HeartbeatTab} agentId=${agent.id} />`}
          </div>
        </div>
      `;
    }

    // ── Soul Tab ─────────────────────────────────────────────────────

    function SoulTab({ agentId }) {
      const [content, setContent] = useState('');
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);

      useEffect(() => {
        setLoading(true);
        api('/agents/' + agentId + '/soul')
          .then(d => setContent(d.content || ''))
          .catch(e => showToast('Failed to load SOUL.md: ' + e.message, 'error'))
          .finally(() => setLoading(false));
      }, [agentId]);

      const save = async () => {
        setSaving(true);
        try {
          await api('/agents/' + agentId + '/soul', { method: 'PUT', body: { content } });
          showToast('SOUL.md saved successfully', 'success');
        } catch (e) { showToast('Save failed: ' + e.message, 'error'); }
        setSaving(false);
      };

      if (loading) return html`<${LoadingState} text="Loading SOUL.md..." />`;

      return html`
        <div>
          <textarea
            class="mono-editor w-full"
            style="min-height:420px;max-height:70vh"
            value=${content}
            onInput=${e => setContent(e.target.value)}
            placeholder="# SOUL.md - Who You Are..."
            spellcheck="false"
          />
          <div class="flex items-center justify-between mt-3">
            <span class="text-xs" style="color:#484f58">${content.length} characters</span>
            <button class="btn btn-primary" onClick=${save} disabled=${saving}>
              ${saving ? 'Saving...' : 'Save SOUL.md'}
            </button>
          </div>
        </div>
      `;
    }

    // ── Identity Tab ─────────────────────────────────────────────────

    function IdentityTab({ agentId }) {
      const [form, setForm] = useState({ name: '', creature: '', vibe: '', emoji: '', avatar: '' });
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);

      useEffect(() => {
        setLoading(true);
        api('/agents/' + agentId)
          .then(d => {
            const a = d.agent || {};
            setForm({
              name:     a.name     || '',
              creature: a.creature || '',
              vibe:     a.vibe     || '',
              emoji:    a.emoji    || '',
              avatar:   a.avatar   || '',
            });
          })
          .catch(e => showToast('Failed to load identity: ' + e.message, 'error'))
          .finally(() => setLoading(false));
      }, [agentId]);

      const upd = (k, v) => setForm(prev => ({ ...prev, [k]: v }));

      const save = async () => {
        setSaving(true);
        try {
          await api('/agents/' + agentId, { method: 'PUT', body: form });
          showToast('Identity saved', 'success');
        } catch (e) { showToast('Save failed: ' + e.message, 'error'); }
        setSaving(false);
      };

      if (loading) return html`<${LoadingState} text="Loading identity..." />`;

      const fields = [
        { key: 'name',     label: 'Name',     ph: 'e.g. Sparky' },
        { key: 'creature', label: 'Creature',  ph: 'e.g. AI familiar, ghost in the machine' },
        { key: 'vibe',     label: 'Vibe',      ph: 'e.g. sharp, warm, chaotic' },
        { key: 'emoji',    label: 'Emoji',     ph: 'Pick one that feels right' },
        { key: 'avatar',   label: 'Avatar',    ph: 'URL or workspace-relative path' },
      ];

      return html`
        <div class="max-w-lg space-y-4">
          ${fields.map(f => html`
            <div key=${f.key}>
              <label class="block text-xs font-medium mb-1.5" style="color:#8b949e">${f.label}</label>
              <input type="text" value=${form[f.key]} onInput=${e => upd(f.key, e.target.value)} placeholder=${f.ph} />
            </div>
          `)}
          <div class="flex justify-end pt-2">
            <button class="btn btn-primary" onClick=${save} disabled=${saving}>
              ${saving ? 'Saving...' : 'Save Identity'}
            </button>
          </div>
        </div>
      `;
    }

    // ── Tools Tab (THE critical visual element) ──────────────────────

    function ToolsTab({ agent, onRefresh }) {
      const initial = useMemo(() => {
        if (agent.toolPreset === 'custom') return agent.customTools || [];
        return PRESET_MAP[agent.toolPreset] || PRESET_MAP.full;
      }, [agent.id, agent.toolPreset]);

      const [enabled, setEnabled] = useState([...initial]);
      const [saving, setSaving] = useState(false);
      const preset = detectPreset(enabled);

      useEffect(() => { setEnabled([...initial]); }, [initial]);

      const toggle = (id) => {
        setEnabled(prev => prev.includes(id) ? prev.filter(t => t !== id) : [...prev, id]);
      };

      const applyPreset = (name) => setEnabled([...PRESET_MAP[name]]);

      const save = async () => {
        setSaving(true);
        try {
          const p = detectPreset(enabled);
          const body = p !== 'custom'
            ? { toolPreset: p, customTools: [] }
            : { toolPreset: 'custom', customTools: enabled };
          await api('/agents/' + agent.id, { method: 'PUT', body });
          showToast('Tool configuration saved', 'success');
          onRefresh && onRefresh();
        } catch (e) { showToast('Save failed: ' + e.message, 'error'); }
        setSaving(false);
      };

      const totalEnabled = enabled.length;
      const totalTools = ALL_TOOL_IDS.length;

      return html`
        <div>
          <!-- Preset buttons row -->
          <div class="flex items-center flex-wrap gap-2 mb-6">
            <button class="preset-btn preset-potato ${preset === 'potato' ? 'selected' : ''}" onClick=${() => applyPreset('potato')}>
              \u{1F954} Potato
            </button>
            <button class="preset-btn preset-coding ${preset === 'coding' ? 'selected' : ''}" onClick=${() => applyPreset('coding')}>
              \u{1F4BB} Coding
            </button>
            <button class="preset-btn preset-messaging ${preset === 'messaging' ? 'selected' : ''}" onClick=${() => applyPreset('messaging')}>
              \u{1F4E8} Messaging
            </button>
            <button class="preset-btn preset-full ${preset === 'full' ? 'selected' : ''}" onClick=${() => applyPreset('full')}>
              \u{1F680} Full
            </button>
            ${preset === 'custom' && html`
              <span class="text-xs font-mono px-3 py-1 rounded" style="background:rgba(139,148,158,0.1);color:#8b949e">custom</span>
            `}
            <span class="ml-auto text-xs" style="color:#484f58">${totalEnabled}/${totalTools} tools enabled</span>
          </div>

          <!-- Tool category sections -->
          <div class="space-y-6">
            ${TOOL_CATEGORIES.map(cat => {
              const catEnabled = cat.tools.filter(t => enabled.includes(t.id)).length;
              return html`
                <div key=${cat.name}>
                  <div class="flex items-center gap-2 mb-3">
                    <span class="text-base">${cat.icon}</span>
                    <h4 class="text-sm font-semibold" style="color:#e6edf3">${cat.label}</h4>
                    <span class="text-xs px-1.5 rounded" style="background:${catEnabled === cat.tools.length ? 'rgba(63,185,80,0.15)' : catEnabled > 0 ? 'rgba(210,153,34,0.15)' : 'rgba(139,148,158,0.1)'};color:${catEnabled === cat.tools.length ? '#3fb950' : catEnabled > 0 ? '#d29922' : '#8b949e'}">
                      ${catEnabled}/${cat.tools.length}
                    </span>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
                    ${cat.tools.map(tool => {
                      const on = enabled.includes(tool.id);
                      return html`
                        <div key=${tool.id} class="tool-card ${on ? 'enabled' : ''}">
                          <div class="min-w-0">
                            <div class="text-sm font-medium truncate" style="color:${on ? '#e6edf3' : '#8b949e'};font-family:ui-monospace,'SF Mono',SFMono-Regular,monospace;font-size:13px">
                              ${tool.id}
                            </div>
                            <div class="text-xs mt-0.5 truncate" style="color:#484f58">${tool.desc}</div>
                          </div>
                          <${Toggle} active=${on} onToggle=${() => toggle(tool.id)} />
                        </div>
                      `;
                    })}
                  </div>
                </div>
              `;
            })}
          </div>

          <!-- Save bar -->
          <div class="flex items-center justify-between mt-6 pt-4" style="border-top:1px solid #30363d">
            <span class="text-xs" style="color:#484f58">
              Preset: <span style="color:#8b949e">${preset}</span>
            </span>
            <button class="btn btn-primary" onClick=${save} disabled=${saving}>
              ${saving ? 'Saving...' : 'Save Tool Config'}
            </button>
          </div>
        </div>
      `;
    }

    // ── Memory Tab ───────────────────────────────────────────────────

    function MemoryTab({ agentId }) {
      const [files, setFiles] = useState([]);
      const [selFile, setSelFile] = useState(null);
      const [content, setContent] = useState('');
      const [loading, setLoading] = useState(true);
      const [loadingFile, setLoadingFile] = useState(false);
      const [query, setQuery] = useState('');
      const [results, setResults] = useState(null);

      useEffect(() => {
        setLoading(true);
        setSelFile(null);
        setContent('');
        setResults(null);
        api('/agents/' + agentId + '/memory')
          .then(d => setFiles(d.files || []))
          .catch(e => showToast('Failed to load memory: ' + e.message, 'error'))
          .finally(() => setLoading(false));
      }, [agentId]);

      const openFile = async (file) => {
        setSelFile(file);
        setLoadingFile(true);
        setResults(null);
        try {
          const seg = file === 'MEMORY.md' ? 'MEMORY.md' : encodeURIComponent(file.replace('memory/', ''));
          const d = await api('/agents/' + agentId + '/memory/' + seg);
          setContent(d.content || '');
        } catch (e) {
          showToast('Failed to load file: ' + e.message, 'error');
          setContent('');
        }
        setLoadingFile(false);
      };

      const search = async () => {
        if (!query.trim()) return;
        try {
          const d = await api('/agents/' + agentId + '/memory/search', { method: 'POST', body: { query } });
          setResults(d.results || []);
          setSelFile(null);
        } catch (e) { showToast('Search failed: ' + e.message, 'error'); }
      };

      if (loading) return html`<${LoadingState} text="Loading memory files..." />`;

      return html`
        <div>
          <!-- Search bar -->
          <div class="flex gap-2 mb-4">
            <input
              type="text" class="flex-1"
              value=${query}
              onInput=${e => setQuery(e.target.value)}
              onKeyDown=${e => e.key === 'Enter' && search()}
              placeholder="Search memory (FTS5)..."
            />
            <button class="btn btn-secondary" onClick=${search}>Search</button>
          </div>

          ${results !== null ? html`
            <!-- Search results view -->
            <div>
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm" style="color:#8b949e">${results.length} result${results.length !== 1 ? 's' : ''}</span>
                <button class="text-xs" style="color:#58a6ff;background:none;border:none;cursor:pointer" onClick=${() => setResults(null)}>Clear results</button>
              </div>
              ${results.length === 0
                ? html`<div class="text-sm py-4" style="color:#8b949e">No matching entries found.</div>`
                : html`
                  <div class="space-y-2">
                    ${results.map((r, i) => html`
                      <div key=${i} class="p-3 rounded-lg" style="background:#1c2128;border:1px solid #30363d">
                        <div class="text-xs font-mono mb-1" style="color:#58a6ff">${r.file || r.file_path || r.filename || 'memory'}</div>
                        <div class="text-sm" style="color:#e6edf3;white-space:pre-wrap">${r.snippet || r.chunk_text || r.content || JSON.stringify(r)}</div>
                      </div>
                    `)}
                  </div>
                `
              }
            </div>
          ` : html`
            <!-- File list + content viewer -->
            <div class="flex gap-4" style="min-height:300px">
              <div style="min-width:180px;max-width:200px" class="space-y-0.5 overflow-y-auto">
                ${files.length === 0
                  ? html`<div class="text-sm py-2" style="color:#8b949e">No files.</div>`
                  : files.map(f => html`
                    <div
                      key=${f}
                      class="px-3 py-2 rounded cursor-pointer text-sm truncate transition-colors"
                      style="background:${selFile === f ? 'rgba(88,166,255,0.1)' : 'transparent'};color:${selFile === f ? '#58a6ff' : '#8b949e'}"
                      onClick=${() => openFile(f)}
                    >
                      \u{1F4C4} ${f}
                    </div>
                  `)
                }
              </div>
              <div class="flex-1 min-w-0">
                ${selFile
                  ? loadingFile
                    ? html`<${LoadingState} text="Loading file..." />`
                    : html`
                      <div>
                        <div class="text-xs font-mono mb-2" style="color:#8b949e">${selFile}</div>
                        <pre
                          class="p-4 rounded-lg text-sm overflow-auto"
                          style="background:#0f1117;border:1px solid #30363d;color:#e6edf3;font-family:ui-monospace,'SF Mono',monospace;max-height:450px;white-space:pre-wrap;margin:0"
                        >${content}</pre>
                      </div>
                    `
                  : html`<div class="flex items-center justify-center h-full text-sm" style="color:#484f58">Select a file to view its contents.</div>`
                }
              </div>
            </div>
          `}
        </div>
      `;
    }

    // ── Heartbeat Tab ────────────────────────────────────────────────

    function HeartbeatTab({ agentId }) {
      const [content, setContent] = useState('');
      const [interval, setInterval_] = useState('30m');
      const [activeStart, setActiveStart] = useState('09:00');
      const [activeEnd, setActiveEnd] = useState('22:00');
      const [hbEnabled, setHbEnabled] = useState(false);
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);

      useEffect(() => {
        setLoading(true);
        Promise.all([
          api('/agents/' + agentId + '/heartbeat').catch(() => ({ content: '' })),
          api('/agents/' + agentId).catch(() => ({ agent: {} })),
        ]).then(([hb, ag]) => {
          setContent(hb.content || '');
          const c = ag.agent?.heartbeat || {};
          setInterval_(c.interval || '30m');
          setActiveStart(c.activeHours?.start || '09:00');
          setActiveEnd(c.activeHours?.end || '22:00');
          setHbEnabled(!!c.enabled);
        }).finally(() => setLoading(false));
      }, [agentId]);

      const save = async () => {
        setSaving(true);
        try {
          await Promise.all([
            api('/agents/' + agentId + '/heartbeat', { method: 'PUT', body: { content } }),
            api('/agents/' + agentId, {
              method: 'PUT',
              body: {
                heartbeat: {
                  enabled: hbEnabled,
                  interval,
                  activeHours: { start: activeStart, end: activeEnd },
                },
              },
            }),
          ]);
          showToast('Heartbeat settings saved', 'success');
        } catch (e) { showToast('Save failed: ' + e.message, 'error'); }
        setSaving(false);
      };

      if (loading) return html`<${LoadingState} text="Loading heartbeat..." />`;

      return html`
        <div class="max-w-2xl">
          <!-- Enable toggle -->
          <div class="flex items-center gap-3 mb-5">
            <${Toggle} active=${hbEnabled} onToggle=${v => setHbEnabled(v)} />
            <span class="text-sm font-medium" style="color:${hbEnabled ? '#3fb950' : '#8b949e'}">
              Heartbeat ${hbEnabled ? 'enabled' : 'disabled'}
            </span>
          </div>

          <!-- Settings row -->
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-5">
            <div>
              <label class="block text-xs font-medium mb-1.5" style="color:#8b949e">Interval</label>
              <select value=${interval} onChange=${e => setInterval_(e.target.value)}>
                <option value="15m">15 minutes</option>
                <option value="30m">30 minutes</option>
                <option value="1h">1 hour</option>
                <option value="4h">4 hours</option>
                <option value="daily">Daily</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium mb-1.5" style="color:#8b949e">Active From</label>
              <input type="time" value=${activeStart} onInput=${e => setActiveStart(e.target.value)} />
            </div>
            <div>
              <label class="block text-xs font-medium mb-1.5" style="color:#8b949e">Active Until</label>
              <input type="time" value=${activeEnd} onInput=${e => setActiveEnd(e.target.value)} />
            </div>
          </div>

          <!-- HEARTBEAT.md editor -->
          <div class="mb-4">
            <label class="block text-xs font-medium mb-1.5" style="color:#8b949e">HEARTBEAT.md</label>
            <textarea
              class="mono-editor w-full"
              style="min-height:260px"
              value=${content}
              onInput=${e => setContent(e.target.value)}
              placeholder="# Heartbeat Checklist..."
              spellcheck="false"
            />
          </div>

          <div class="flex justify-end">
            <button class="btn btn-primary" onClick=${save} disabled=${saving}>
              ${saving ? 'Saving...' : 'Save Heartbeat'}
            </button>
          </div>
        </div>
      `;
    }

    // ═══════════════════════════════════════════════════════════════════
    //  PAGE 3: Sessions
    // ═══════════════════════════════════════════════════════════════════

    function SessionsPage({ sessions, onRefresh }) {
      const [expandedId, setExpandedId] = useState(null);
      const [msgText, setMsgText] = useState('');
      const [sending, setSending] = useState(false);
      const [response, setResponse] = useState(null);

      const toggleRow = (id) => {
        setExpandedId(prev => prev === id ? null : id);
        setMsgText('');
        setResponse(null);
      };

      const sendMsg = async (sid) => {
        if (!msgText.trim()) return;
        setSending(true);
        setResponse(null);
        try {
          const d = await api('/sessions/' + sid + '/send', { method: 'POST', body: { text: msgText } });
          setResponse(d.response || 'Message sent successfully.');
          setMsgText('');
          showToast('Message sent', 'success');
          onRefresh && onRefresh();
        } catch (e) { showToast('Send failed: ' + e.message, 'error'); }
        setSending(false);
      };

      const terminate = async (id, ev) => {
        ev && ev.stopPropagation();
        try {
          await api('/sessions/' + id, { method: 'DELETE' });
          showToast('Session terminated', 'success');
          onRefresh && onRefresh();
        } catch (e) { showToast('Terminate failed: ' + e.message, 'error'); }
      };

      return html`
        <div class="page-enter p-6">
          <div class="flex items-center justify-between mb-5">
            <h2 class="text-xl font-semibold" style="color:#e6edf3">Sessions</h2>
            <button class="btn btn-secondary" onClick=${onRefresh}>Refresh</button>
          </div>

          ${sessions.length === 0
            ? html`<${EmptyState} icon="\u{1F4AC}" title="No sessions" subtitle="Sessions appear when agents start conversations" />`
            : html`
              <div class="rounded-lg overflow-hidden" style="border:1px solid #30363d">
                <table class="w-full" style="border-collapse:collapse">
                  <thead>
                    <tr style="background:#161b22">
                      <th class="text-left text-xs font-medium px-4 py-3" style="color:#8b949e">Session ID</th>
                      <th class="text-left text-xs font-medium px-4 py-3" style="color:#8b949e">Agent</th>
                      <th class="text-left text-xs font-medium px-4 py-3" style="color:#8b949e">Label</th>
                      <th class="text-left text-xs font-medium px-4 py-3" style="color:#8b949e">Channel</th>
                      <th class="text-left text-xs font-medium px-4 py-3" style="color:#8b949e">Status</th>
                      <th class="text-left text-xs font-medium px-4 py-3" style="color:#8b949e">Last Active</th>
                      <th class="text-right text-xs font-medium px-4 py-3" style="color:#8b949e">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${sessions.map(s => {
                      const aid = s.agentId || s.agent_id || '--';
                      const ch = s.channel || '--';
                      const badge = s.status === 'active' ? 'badge-green' : s.status === 'idle' ? 'badge-yellow' : 'badge-gray';
                      const isExpanded = expandedId === s.id;
                      return html`
                        <tr
                          key=${s.id}
                          class="cursor-pointer transition-colors"
                          style="border-top:1px solid #30363d;background:${isExpanded ? '#1c2128' : 'transparent'}"
                          onClick=${() => toggleRow(s.id)}
                        >
                          <td class="px-4 py-3 font-mono text-xs" style="color:#58a6ff">${s.id.length > 12 ? s.id.slice(0,12) + '\u{2026}' : s.id}</td>
                          <td class="px-4 py-3 text-sm" style="color:#e6edf3">${aid}</td>
                          <td class="px-4 py-3 text-sm truncate" style="color:#8b949e;max-width:200px">${s.label || '--'}</td>
                          <td class="px-4 py-3 text-sm" style="color:#8b949e">${ch}</td>
                          <td class="px-4 py-3"><span class="badge ${badge}">${s.status}</span></td>
                          <td class="px-4 py-3 text-xs" style="color:#8b949e">${fmtDate(s.lastActiveAt || s.last_active_at)}</td>
                          <td class="px-4 py-3 text-right">
                            ${s.status !== 'terminated' && html`
                              <button class="btn btn-danger" style="padding:4px 10px;font-size:12px" onClick=${(e) => terminate(s.id, e)}>Terminate</button>
                            `}
                          </td>
                        </tr>
                        ${isExpanded && html`
                          <tr key=${s.id + '-exp'}>
                            <td colspan="7" class="px-4 py-4" style="border-top:1px solid #30363d;background:#161b22">
                              <div class="flex gap-2 mb-3">
                                <input
                                  type="text" class="flex-1"
                                  value=${msgText}
                                  onInput=${e => setMsgText(e.target.value)}
                                  onKeyDown=${e => e.key === 'Enter' && sendMsg(s.id)}
                                  placeholder="Send a message to this session..."
                                  onClick=${e => e.stopPropagation()}
                                />
                                <button class="btn btn-accent" onClick=${e => { e.stopPropagation(); sendMsg(s.id); }} disabled=${sending}>
                                  ${sending ? 'Sending...' : 'Send'}
                                </button>
                              </div>
                              ${response && html`
                                <div class="p-3 rounded-lg text-sm overflow-auto" style="background:#0f1117;border:1px solid #30363d;color:#e6edf3;white-space:pre-wrap;max-height:200px" onClick=${e => e.stopPropagation()}>
                                  ${response}
                                </div>
                              `}
                            </td>
                          </tr>
                        `}
                      `;
                    })}
                  </tbody>
                </table>
              </div>
            `
          }
        </div>
      `;
    }

    // ═══════════════════════════════════════════════════════════════════
    //  PAGE 4: Skills
    // ═══════════════════════════════════════════════════════════════════

    function SkillsPage({ skills, onRefresh }) {
      const [pkgName, setPkgName] = useState('');
      const [installing, setInstalling] = useState(false);

      const active   = skills.filter(s => s.status === 'active');
      const pending  = skills.filter(s => s.status === 'pending');
      const disabled = skills.filter(s => s.status === 'disabled');

      const approve = async (name) => {
        try {
          await api('/skills/' + encodeURIComponent(name) + '/approve', { method: 'POST' });
          showToast('Skill "' + name + '" approved', 'success');
          onRefresh && onRefresh();
        } catch (e) { showToast('Approve failed: ' + e.message, 'error'); }
      };

      const reject = async (name) => {
        try {
          await api('/skills/' + encodeURIComponent(name) + '/reject', { method: 'POST' });
          showToast('Skill "' + name + '" rejected', 'success');
          onRefresh && onRefresh();
        } catch (e) { showToast('Reject failed: ' + e.message, 'error'); }
      };

      const remove = async (name) => {
        try {
          await api('/skills/' + encodeURIComponent(name), { method: 'DELETE' });
          showToast('Skill removed', 'success');
          onRefresh && onRefresh();
        } catch (e) { showToast('Remove failed: ' + e.message, 'error'); }
      };

      const install = async () => {
        if (!pkgName.trim()) return;
        setInstalling(true);
        showToast('Skill install requested: ' + pkgName, 'info');
        setPkgName('');
        setInstalling(false);
      };

      return html`
        <div class="page-enter p-6">
          <div class="flex items-center justify-between mb-5">
            <h2 class="text-xl font-semibold" style="color:#e6edf3">Skills</h2>
            <button class="btn btn-secondary" onClick=${onRefresh}>Refresh</button>
          </div>

          <!-- Pending approval section -->
          ${pending.length > 0 && html`
            <div class="mb-6">
              <h3 class="text-sm font-semibold mb-3 flex items-center gap-2" style="color:#d29922">
                \u{23F3} Pending Approval (${pending.length})
              </h3>
              <div class="space-y-2">
                ${pending.map(s => html`
                  <div key=${s.name} class="flex items-center justify-between p-4 rounded-lg" style="background:#1c2128;border:1px solid rgba(210,153,34,0.3)">
                    <div class="min-w-0">
                      <div class="text-sm font-medium" style="color:#e6edf3">${s.name}</div>
                      ${s.description && html`<div class="text-xs mt-0.5 truncate" style="color:#8b949e">${s.description}</div>`}
                      ${(s.requestedBy || s.requested_by) && html`<div class="text-xs mt-0.5" style="color:#484f58">Requested by: ${s.requestedBy || s.requested_by}</div>`}
                    </div>
                    <div class="flex gap-2 flex-shrink-0 ml-4">
                      <button class="btn btn-primary" style="padding:4px 14px;font-size:13px" onClick=${() => approve(s.name)}>Approve</button>
                      <button class="btn btn-danger" style="padding:4px 14px;font-size:13px" onClick=${() => reject(s.name)}>Reject</button>
                    </div>
                  </div>
                `)}
              </div>
            </div>
          `}

          <!-- Active skills section -->
          <div class="mb-6">
            <h3 class="text-sm font-semibold mb-3 flex items-center gap-2" style="color:#3fb950">
              \u{2705} Active Skills (${active.length})
            </h3>
            ${active.length === 0
              ? html`<div class="p-4 rounded-lg text-sm" style="background:#1c2128;border:1px solid rgba(63,185,80,0.2);color:#8b949e">No active skills installed.</div>`
              : html`
                <div class="space-y-2">
                  ${active.map(s => html`
                    <div key=${s.name} class="flex items-center justify-between p-4 rounded-lg" style="background:#1c2128;border:1px solid rgba(63,185,80,0.3)">
                      <div class="min-w-0">
                        <div class="text-sm font-medium" style="color:#e6edf3">${s.name}</div>
                        ${s.description && html`<div class="text-xs mt-0.5 truncate" style="color:#8b949e">${s.description}</div>`}
                      </div>
                      <button class="btn btn-danger flex-shrink-0 ml-4" style="padding:4px 14px;font-size:13px" onClick=${() => remove(s.name)}>Remove</button>
                    </div>
                  `)}
                </div>
              `
            }
          </div>

          <!-- Disabled skills -->
          ${disabled.length > 0 && html`
            <div class="mb-6">
              <h3 class="text-sm font-semibold mb-3 flex items-center gap-2" style="color:#8b949e">
                \u{26D4} Disabled (${disabled.length})
              </h3>
              <div class="space-y-2">
                ${disabled.map(s => html`
                  <div key=${s.name} class="flex items-center justify-between p-4 rounded-lg" style="background:#1c2128;border:1px solid #30363d">
                    <span class="text-sm" style="color:#8b949e">${s.name}</span>
                    <button class="btn btn-danger flex-shrink-0 ml-4" style="padding:4px 14px;font-size:13px" onClick=${() => remove(s.name)}>Remove</button>
                  </div>
                `)}
              </div>
            </div>
          `}

          <!-- Install skill form -->
          <div class="mt-8 p-5 rounded-lg" style="background:#1c2128;border:1px solid #30363d">
            <h3 class="text-sm font-semibold mb-3" style="color:#e6edf3">Install Skill</h3>
            <div class="flex gap-2">
              <input
                type="text" class="flex-1"
                value=${pkgName}
                onInput=${e => setPkgName(e.target.value)}
                onKeyDown=${e => e.key === 'Enter' && install()}
                placeholder="npm package name (e.g. @mcp/weather-server)"
              />
              <button class="btn btn-primary" onClick=${install} disabled=${installing}>
                ${installing ? 'Installing...' : 'Install'}
              </button>
            </div>
            <p class="text-xs mt-2" style="color:#484f58">Skills are standard MCP servers from npm. New skills go to pending and require approval.</p>
          </div>
        </div>
      `;
    }

    // ═══════════════════════════════════════════════════════════════════
    //  PAGE 5: Channels
    // ═══════════════════════════════════════════════════════════════════

    function ChannelsPage({ channels, onRefresh }) {
      const [tokens, setTokens] = useState({});

      const CHANNEL_META = {
        telegram: { icon: '\u{2708}\u{FE0F}',  label: 'Telegram',  tokenLabel: 'TELEGRAM_BOT_TOKEN', desc: 'Bot API via grammy' },
        slack:    { icon: '\u{1F4AC}', label: 'Slack',     tokenLabel: 'SLACK_BOT_TOKEN',    desc: 'Socket Mode via @slack/bolt' },
        discord:  { icon: '\u{1F3AE}', label: 'Discord',   tokenLabel: 'DISCORD_BOT_TOKEN',  desc: 'Bot integration via discord.js' },
        webchat:  { icon: '\u{1F310}', label: 'WebChat',   tokenLabel: null,                  desc: 'Built-in browser WebSocket chat' },
      };

      const allChannels = Object.keys(CHANNEL_META).map(name => {
        const found = channels.find(c => c.name === name);
        return { name, connected: found ? found.connected : false };
      });

      const toggleConnect = async (name, connect) => {
        try {
          await api('/channels/' + name + '/' + (connect ? 'connect' : 'disconnect'), { method: 'POST' });
          showToast(CHANNEL_META[name].label + ' ' + (connect ? 'connected' : 'disconnected'), 'success');
          onRefresh && onRefresh();
        } catch (e) { showToast('Failed: ' + e.message, 'error'); }
      };

      return html`
        <div class="page-enter p-6">
          <div class="flex items-center justify-between mb-5">
            <h2 class="text-xl font-semibold" style="color:#e6edf3">Channels</h2>
            <button class="btn btn-secondary" onClick=${onRefresh}>Refresh</button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${allChannels.map(ch => {
              const meta = CHANNEL_META[ch.name];
              return html`
                <div key=${ch.name} class="p-5 rounded-lg" style="background:#1c2128;border:1px solid #30363d">
                  <!-- Header -->
                  <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                      <span class="text-xl">${meta.icon}</span>
                      <div>
                        <div class="font-semibold text-sm" style="color:#e6edf3">${meta.label}</div>
                        <div class="text-xs" style="color:#484f58">${meta.desc}</div>
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      <${StatusDot} connected=${ch.connected} />
                      <span class="text-xs" style="color:${ch.connected ? '#3fb950' : '#8b949e'}">
                        ${ch.connected ? 'Connected' : 'Disconnected'}
                      </span>
                    </div>
                  </div>

                  <!-- Enable toggle -->
                  <div class="flex items-center gap-3 mb-4">
                    <span class="text-xs font-medium" style="color:#8b949e">Enable</span>
                    <${Toggle} active=${ch.connected} onToggle=${v => toggleConnect(ch.name, v)} />
                  </div>

                  <!-- Token input (if applicable) -->
                  ${meta.tokenLabel && html`
                    <div>
                      <label class="block text-xs font-medium mb-1.5" style="color:#8b949e">${meta.tokenLabel}</label>
                      <input
                        type="password"
                        value=${tokens[ch.name] || ''}
                        onInput=${e => setTokens(prev => ({ ...prev, [ch.name]: e.target.value }))}
                        placeholder="\u{2022}\u{2022}\u{2022}\u{2022}\u{2022}\u{2022}\u{2022}\u{2022}\u{2022}\u{2022}\u{2022}\u{2022}\u{2022}\u{2022}\u{2022}\u{2022}"
                      />
                    </div>
                  `}
                </div>
              `;
            })}
          </div>
        </div>
      `;
    }

    // ═══════════════════════════════════════════════════════════════════
    //  PAGE 6: Cron
    // ═══════════════════════════════════════════════════════════════════

    function CronPage({ cronJobs, agents, onRefresh }) {
      const [showForm, setShowForm] = useState(false);
      const [form, setForm] = useState({ name: '', schedule: '0 * * * *', agentId: '', prompt: '' });
      const [creating, setCreating] = useState(false);

      const upd = (k, v) => setForm(prev => ({ ...prev, [k]: v }));

      const createJob = async () => {
        if (!form.name || !form.schedule || !form.agentId || !form.prompt) {
          showToast('All fields are required', 'error');
          return;
        }
        setCreating(true);
        try {
          await api('/cron', { method: 'POST', body: form });
          showToast('Cron job created', 'success');
          setForm({ name: '', schedule: '0 * * * *', agentId: '', prompt: '' });
          setShowForm(false);
          onRefresh && onRefresh();
        } catch (e) { showToast('Create failed: ' + e.message, 'error'); }
        setCreating(false);
      };

      const toggleJob = async (job) => {
        try {
          await api('/cron/' + job.id, { method: 'PUT', body: { enabled: !job.enabled } });
          showToast('Job ' + (job.enabled ? 'disabled' : 'enabled'), 'success');
          onRefresh && onRefresh();
        } catch (e) { showToast('Toggle failed: ' + e.message, 'error'); }
      };

      const deleteJob = async (id) => {
        try {
          await api('/cron/' + id, { method: 'DELETE' });
          showToast('Job deleted', 'success');
          onRefresh && onRefresh();
        } catch (e) { showToast('Delete failed: ' + e.message, 'error'); }
      };

      return html`
        <div class="page-enter p-6">
          <div class="flex items-center justify-between mb-5">
            <h2 class="text-xl font-semibold" style="color:#e6edf3">Cron Jobs</h2>
            <button class="btn ${showForm ? 'btn-secondary' : 'btn-primary'}" onClick=${() => setShowForm(!showForm)}>
              ${showForm ? 'Cancel' : '+ Add Job'}
            </button>
          </div>

          <!-- Add job form -->
          ${showForm && html`
            <div class="p-5 rounded-lg mb-6" style="background:#1c2128;border:1px solid #30363d">
              <h3 class="text-sm font-semibold mb-4" style="color:#e6edf3">New Cron Job</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="block text-xs font-medium mb-1.5" style="color:#8b949e">Name</label>
                  <input type="text" value=${form.name} onInput=${e => upd('name', e.target.value)} placeholder="e.g. daily-digest" />
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1.5" style="color:#8b949e">Schedule (cron)</label>
                  <input type="text" value=${form.schedule} onInput=${e => upd('schedule', e.target.value)} placeholder="0 * * * *" style="font-family:ui-monospace,'SF Mono',monospace" />
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1.5" style="color:#8b949e">Agent</label>
                  <select value=${form.agentId} onChange=${e => upd('agentId', e.target.value)}>
                    <option value="">Select agent...</option>
                    ${agents.map(a => html`<option key=${a.id} value=${a.id}>${a.name || a.id}</option>`)}
                  </select>
                </div>
              </div>
              <div class="mb-4">
                <label class="block text-xs font-medium mb-1.5" style="color:#8b949e">Prompt</label>
                <textarea value=${form.prompt} onInput=${e => upd('prompt', e.target.value)} placeholder="What should the agent do on each run..." style="min-height:80px" />
              </div>
              <div class="flex justify-end">
                <button class="btn btn-primary" onClick=${createJob} disabled=${creating}>
                  ${creating ? 'Creating...' : 'Create Job'}
                </button>
              </div>
            </div>
          `}

          <!-- Jobs table -->
          ${cronJobs.length === 0
            ? html`<${EmptyState} icon="\u{23F0}" title="No cron jobs" subtitle="Create a job to run agents on a schedule" />`
            : html`
              <div class="rounded-lg overflow-hidden" style="border:1px solid #30363d">
                <table class="w-full" style="border-collapse:collapse">
                  <thead>
                    <tr style="background:#161b22">
                      <th class="text-left text-xs font-medium px-4 py-3" style="color:#8b949e">Name</th>
                      <th class="text-left text-xs font-medium px-4 py-3" style="color:#8b949e">Schedule</th>
                      <th class="text-left text-xs font-medium px-4 py-3" style="color:#8b949e">Agent</th>
                      <th class="text-left text-xs font-medium px-4 py-3" style="color:#8b949e">Enabled</th>
                      <th class="text-left text-xs font-medium px-4 py-3" style="color:#8b949e">Last Run</th>
                      <th class="text-right text-xs font-medium px-4 py-3" style="color:#8b949e">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${cronJobs.map(job => html`
                      <tr key=${job.id} style="border-top:1px solid #30363d">
                        <td class="px-4 py-3 text-sm font-medium" style="color:#e6edf3">${job.name}</td>
                        <td class="px-4 py-3 text-xs font-mono" style="color:#8b949e">${job.schedule}</td>
                        <td class="px-4 py-3 text-sm" style="color:#8b949e">${job.agentId || job.agent_id || '--'}</td>
                        <td class="px-4 py-3">
                          <${Toggle} active=${!!job.enabled} onToggle=${() => toggleJob(job)} />
                        </td>
                        <td class="px-4 py-3 text-xs" style="color:#8b949e">${fmtDate(job.lastRun || job.last_run_at) || 'Never'}</td>
                        <td class="px-4 py-3 text-right">
                          <button class="btn btn-danger" style="padding:4px 10px;font-size:12px" onClick=${() => deleteJob(job.id)}>Delete</button>
                        </td>
                      </tr>
                    `)}
                  </tbody>
                </table>
              </div>
            `
          }
        </div>
      `;
    }

    // ═══════════════════════════════════════════════════════════════════
    //  PAGE 7: Config
    // ═══════════════════════════════════════════════════════════════════

    function ConfigPage() {
      const [text, setText] = useState('');
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);
      const [parseErr, setParseErr] = useState(null);

      const loadConfig = () => {
        setLoading(true);
        api('/config')
          .then(d => { setText(JSON.stringify(d.config, null, 2)); setParseErr(null); })
          .catch(e => showToast('Failed to load config: ' + e.message, 'error'))
          .finally(() => setLoading(false));
      };

      useEffect(() => { loadConfig(); }, []);

      const handleInput = (e) => {
        const v = e.target.value;
        setText(v);
        try { JSON.parse(v); setParseErr(null); }
        catch (err) { setParseErr(err.message); }
      };

      const save = async () => {
        let parsed;
        try { parsed = JSON.parse(text); }
        catch (e) { showToast('Invalid JSON: ' + e.message, 'error'); return; }
        setSaving(true);
        try {
          await api('/config', { method: 'PUT', body: parsed });
          showToast('Configuration saved successfully', 'success');
        } catch (e) { showToast('Save failed: ' + e.message, 'error'); }
        setSaving(false);
      };

      if (loading) return html`<div class="page-enter p-6"><${LoadingState} text="Loading configuration..." /></div>`;

      return html`
        <div class="page-enter p-6">
          <div class="flex items-center justify-between mb-5">
            <h2 class="text-xl font-semibold" style="color:#e6edf3">Configuration</h2>
            <div class="flex items-center gap-2">
              <button class="btn btn-secondary" onClick=${loadConfig}>Reload</button>
              <button class="btn btn-primary" onClick=${save} disabled=${saving || !!parseErr}>
                ${saving ? 'Saving...' : 'Save Config'}
              </button>
            </div>
          </div>

          ${parseErr && html`
            <div class="mb-4 p-3 rounded-lg text-sm" style="background:rgba(248,81,73,0.1);border:1px solid rgba(248,81,73,0.3);color:#f85149">
              JSON error: ${parseErr}
            </div>
          `}

          <textarea
            class="mono-editor w-full"
            style="min-height:520px;max-height:75vh;tab-size:2"
            value=${text}
            onInput=${handleInput}
            spellcheck="false"
          />

          <p class="text-xs mt-3" style="color:#484f58">
            Validated against the Zod schema on save. Changes take effect immediately.
            File: ~/.clade/config.json
          </p>
        </div>
      `;
    }

    // ═══════════════════════════════════════════════════════════════════
    // App Root
    // ═══════════════════════════════════════════════════════════════════

    function App() {
      // ── State ────────────────────────────────────────────────────
      const [page, setPage]         = useState('dashboard');
      const [selectedAgentId, setSelectedAgentId] = useState(null);
      const [connected, setConn]    = useState(false);
      const [health, setHealth]     = useState(null);
      const [agents, setAgents]     = useState([]);
      const [sessions, setSessions] = useState([]);
      const [skills, setSkills]     = useState([]);
      const [cronJobs, setCronJobs] = useState([]);
      const [channels, setChannels] = useState([]);
      const wsRef = useRef(null);

      // ── Fetch helpers ────────────────────────────────────────────
      const fetchAgents   = useCallback(() => api('/agents').then(d => setAgents(d.agents || [])).catch(() => {}), []);
      const fetchSessions = useCallback(() => api('/sessions').then(d => setSessions(d.sessions || [])).catch(() => {}), []);
      const fetchSkills   = useCallback(() => api('/skills').then(d => setSkills(d.skills || [])).catch(() => {}), []);
      const fetchCron     = useCallback(() => api('/cron').then(d => setCronJobs(d.jobs || [])).catch(() => {}), []);
      const fetchChannels = useCallback(() => api('/channels').then(d => setChannels(d.channels || [])).catch(() => {}), []);
      const fetchHealth   = useCallback(() => healthApi().then(h => { if (h) setHealth(h); }), []);

      const fetchAll = useCallback(() => {
        return Promise.allSettled([
          fetchHealth(), fetchAgents(), fetchSessions(),
          fetchSkills(), fetchCron(), fetchChannels(),
        ]);
      }, [fetchHealth, fetchAgents, fetchSessions, fetchSkills, fetchCron, fetchChannels]);

      // ── WebSocket ────────────────────────────────────────────────
      useEffect(() => {
        let ws;
        let reconTimer;

        const connect = () => {
          const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
          ws = new WebSocket(proto + '//' + location.host + '/ws/admin');
          wsRef.current = ws;

          ws.onopen = () => setConn(true);

          ws.onmessage = (e) => {
            try {
              const msg = JSON.parse(e.data);
              if (msg.type === 'snapshot') {
                fetchAll();
              } else if (msg.type) {
                const domain = msg.type.split(':')[0];
                if (domain === 'agent' || domain === 'memory')  fetchAgents();
                else if (domain === 'session')                   fetchSessions();
                else if (domain === 'skill')                     fetchSkills();
                else if (domain === 'cron')                      fetchCron();
                else if (domain === 'channel' || domain === 'webchat') fetchChannels();
                else if (domain === 'config')                    fetchAll();
              }
            } catch (_) {}
          };

          ws.onclose = () => {
            setConn(false);
            wsRef.current = null;
            reconTimer = setTimeout(connect, 3000);
          };

          ws.onerror = () => ws.close();
        };

        connect();
        return () => { clearTimeout(reconTimer); if (ws) ws.close(); };
      }, [fetchAll, fetchAgents, fetchSessions, fetchSkills, fetchCron, fetchChannels]);

      // ── Initial load ─────────────────────────────────────────────
      useEffect(() => { fetchAll(); }, []);

      // ── Periodic health refresh ──────────────────────────────────
      useEffect(() => {
        const t = setInterval(fetchHealth, 15000);
        return () => clearInterval(t);
      }, [fetchHealth]);

      // Navigate to a specific agent's config page
      const navigateToAgent = useCallback((agentId) => {
        setSelectedAgentId(agentId);
        setPage('agents');
      }, []);

      // ── Page renderer ────────────────────────────────────────────
      const renderPage = () => {
        // Show welcome / onboarding when no agents exist
        if (agents.length === 0 && (page === 'dashboard' || page === 'agents')) {
          return html`<${WelcomePage} onCreated=${fetchAll} />`;
        }

        switch (page) {
          case 'dashboard':
            return html`<${DashboardPage} health=${health} agents=${agents} sessions=${sessions} cronJobs=${cronJobs} onNavigateToAgent=${navigateToAgent} />`;
          case 'chat':
            return html`<${ChatPage} agents=${agents} />`;
          case 'agents':
            return html`<${AgentsPage} agents=${agents} onRefresh=${fetchAgents} onNavigate=${setPage} initialSelectedId=${selectedAgentId} onAgentDeleted=${() => { setSelectedAgentId(null); fetchAll(); }} />`;
          case 'sessions':
            return html`<${SessionsPage} sessions=${sessions} onRefresh=${fetchSessions} />`;
          case 'skills':
            return html`<${SkillsPage} skills=${skills} onRefresh=${fetchSkills} />`;
          case 'channels':
            return html`<${ChannelsPage} channels=${channels} onRefresh=${fetchChannels} />`;
          case 'cron':
            return html`<${CronPage} cronJobs=${cronJobs} agents=${agents} onRefresh=${() => { fetchCron(); fetchAgents(); }} />`;
          case 'config':
            return html`<${ConfigPage} />`;
          default:
            return html`<${DashboardPage} health=${health} agents=${agents} sessions=${sessions} cronJobs=${cronJobs} />`;
        }
      };

      // ── Render ───────────────────────────────────────────────────
      return html`
        <div class="flex h-screen" style="background:#0f1117">
          <${Sidebar} page=${page} setPage=${setPage} agents=${agents} onNavigateToAgent=${navigateToAgent} />
          <div class="flex flex-col flex-1 min-w-0">
            <${TopBar} connected=${connected} health=${health} agents=${agents} />
            <main class="flex-1 overflow-y-auto" style="background:#0f1117">
              ${renderPage()}
            </main>
          </div>
          <${ToastContainer} />
        </div>
      `;
    }

    // ═══════════════════════════════════════════════════════════════════
    // Mount application
    // ═══════════════════════════════════════════════════════════════════
    render(html`<${App} />`, document.getElementById('app'));
  </script>
</body>
</html>
